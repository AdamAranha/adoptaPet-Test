;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "13.0-25-g6015dbc";},getModuleName:function(){return "prezi_playback";},getModuleVersion:function(){return "release-2021w06-base-26-gaeb382e";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.engine.dom":dependencies[0],"prezi.geometry":dependencies[1],"prezi.text.model":dependencies[2],"prezi_app_utils":dependencies[3],"prezi_bacon":dependencies[4],"prezi_canvas_listener":dependencies[5],"prezi_cet":dependencies[6],"prezi_cet_model":dependencies[7],"prezi_cet_model_editor":dependencies[8],"prezi_cet_renderer":dependencies[9],"prezi_editor_store_mode":dependencies[10],"prezi_editor_store_object":dependencies[11],"prezi_externalserviceprovider":dependencies[12],"prezi_featureswitcher":dependencies[13],"prezi_logger":dependencies[14],"prezi_select":dependencies[15],"prezi_uaparser":dependencies[16],"prezi_utils":dependencies[17]}};})());};})(arguments);var moduleImpl=(function(){return module(function(v){var E=v.dependencies["prezi.geometry"],A=v.dependencies.prezi_externalserviceprovider,Y=v.dependencies.prezi_featureswitcher,J=v.dependencies.prezi_logger,Z=v.dependencies.prezi_uaparser,D=v.dependencies.prezi_utils,l=v.dependencies.prezi_app_utils,n=v.dependencies.prezi_bacon,e=v.dependencies.prezi_cet,h=v.dependencies.prezi_cet_model,f=v.dependencies.prezi_cet_model_editor,r=v.dependencies.prezi_cet_renderer,aa=v.dependencies.prezi_editor_store_object,F=v.dependencies.prezi_select,
p=v.dependencies.prezi_canvas_listener,B=v.dependencies.prezi_editor_store_mode,x={};Object.defineProperty(x,"__esModule",{value:!0});x.SnapLimits=class{constructor(){this.lastScrollTime=0;this.ease=!1;this.inFlyDeltas=[];this.inFlyTimes=[];this.flyStartTime=-1;this.zoomOutLimitRatio=1.2;this.currentTopicActivationRatio=.2;this.cameraFlySpeedMultiplier=.8;this.childSnapRatio=.01}getScrollOutSnapToEntityRatio(){return x.SnapLimits.SCROLL_OUT_SNAP_TO_ENTITY_RATIO}getScrollInSnapToEntityRatio(){return x.SnapLimits.SCROLL_IN_SNAP_TO_ENTITY_RATIO}getCameraFlySpeedMultiplier(a=
!0){return a?this.cameraFlySpeedMultiplier:x.SnapLimits.SCROLL_NON_TOPIC_TARGET_FLY_SPEED_MULTIPLIER}getCenterDistanceScreenDiagonalRatio(){return x.SnapLimits.CENTER_DISTANCE_SCREEN_DIAGONAL_RATIO}getChildSnapRatio(){return this.childSnapRatio}getCurrentTopicActivationRatio(){return this.currentTopicActivationRatio}getZoomOutToCurrentBound(){return this.zoomOutLimitRatio}withinActiveTrashhold(a,b,c){a=this.fillRatio(a,c);return b<a}withinChildSnapLimit(a,b,c){a=this.fillRatio(a,c);return b<a+x.SnapLimits.EPS}fillRatio(a,
b){b=b.viewportInWorld();b=b.getWidth()*b.getHeight();a=e.Cet.world(a).getWorldBounds().getBounds();return a.getWidth()*a.getHeight()/b}fillRatioForNavigationImprovements(a,b,c){a=e.Cet.getTargetTransform(c,a.getId(),b.getMarginCorrectedViewport()).getScale();b=b.getTransform().getScale();return Math.round(b/a*100)/100}collectScrollEvent(a){0===this.inFlyDeltas.length?this.inFlyDeltas.push(0):this.inFlyDeltas.push(a-this.inFlyTimes[this.inFlyTimes.length-1]);this.inFlyTimes.push(a);return this}resetScrollMeasurements(){this.flyStartTime=
-1;this.inFlyTimes=[];this.inFlyDeltas=[];this.ease=!1;this.lastScrollTime=0;return this}addEventMeasurement(a){var b=(a)=>{a=this.inFlyDeltas[this.inFlyDeltas.length-a];return null==a?0:a};if(0<this.inFlyDeltas.length&&100>this.inFlyDeltas.length){const c=a-this.inFlyTimes[this.inFlyTimes.length-1];b=Math.max(b(1),b(2),b(3),b(4),b(5),b(6));if(c<2*b&&128>c)return this.inFlyDeltas.push(c),this.inFlyTimes.push(a),this.ease=!0,this}this.ease=!1;return this}updateScrollTime(a){this.lastScrollTime=a;return this}updateFlyStartTime(a){this.flyStartTime=
a;return this}isTouchpadEaseDetected(){return this.ease}};x.SnapLimits.EPS=1E-5;x.SnapLimits.SCROLL_OUT_SNAP_TO_ENTITY_RATIO=1.6;x.SnapLimits.SCROLL_IN_SNAP_TO_ENTITY_RATIO=.6;x.SnapLimits.SCROLL_NON_TOPIC_TARGET_FLY_SPEED_MULTIPLIER=.5;x.SnapLimits.CENTER_DISTANCE_SCREEN_DIAGONAL_RATIO=.2;var K={};Object.defineProperty(K,"__esModule",{value:!0});const ba=h.CetModel.ID.Z_VIDEO;K.InteractionQueryImpl=class{constructor(){this.snapLimits=new x.SnapLimits}shouldTriggerScrollGesture(a,b,c,d,g){if(null==
a||null==a.getData().entity)return!1;const k=c.viewportInWorld().getCenter(),t=a.getData().entity;a=()=>{if(0===g&&f.CetModelEditor.isPlanetOrStack(t.getId(),d))return!0;let a=this.snapLimits.fillRatioForNavigationImprovements(t,c,d);switch(g){case 1:return a<this.snapLimits.getScrollOutSnapToEntityRatio()&&1<a;case 0:return a>this.snapLimits.getScrollInSnapToEntityRatio()&&1>a}};const z=()=>0===g?!0:-1<b.getEntitiesByWorldPoint(k).filter((a)=>a.is(f.HitTag.CLICKED_IN_WORLD_BOUNDS)).entities().map((a)=>
a.getId()).indexOf(t.getId()),w=()=>{if(0===g&&f.CetModelEditor.isPlanetOrStack(t.getId(),d))return!0;var a=e.Cet.world(t).getWorldBounds().getCenter();a=c.worldPointToScreen(a);const b=c.worldPointToScreen(k);var h=c.getStageArea();h=Math.sqrt(Math.pow(h.getWidth(),2)+Math.pow(h.getHeight(),2));return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))<h*this.snapLimits.getCenterDistanceScreenDiagonalRatio()};return c.getFocusedEntity()!==t.getId()&&(f.CetModelEditor.createTopicQuery(d).getTopicKind(t.getId())!==
f.TopicKind.None||t.isDef(h.CetModel.ID.Z_ZOOM_AREA))&&a()&&z()&&w()}getChapterOrFirstPageIfStack(a,b){let c=f.CetModelEditor.getPagesOfChapter(b,a);return 0<c.length?a.getEntityById(c[0]):a.getEntityById(b)}getParentChapterOrOverview(a,b){b=e.Cet.createHierarchyQuery(a).getAncestorEntities(b.getId()).filter((b)=>f.CetModelEditor.isOverview(b,a)||f.CetModelEditor.isPlanet(b,a));return a.getEntityById(b[0])}getEntityForScrollOut(a,b,c,d,g,k){if(this.isInFreeZoomingCoverEditMode(k))return null;if(d.getFocusedEntity()===
g.getId())return this.getParentChapterOrOverview(a,g);c=b.getEntitiesByWorldPoint(c).apply(b.strategies().general(!0)).apply(b.strategies().replaceCoverWithTopic(a)).filter((c)=>this.shouldTriggerScrollGesture(c,b,d,a,1)).entities().map((b)=>null!=b&&f.CetModelEditor.createTopicQuery(a).getTopicKind(b.getId())===f.TopicKind.Stack?this.getParentChapterOrOverview(a,b):b)[0];if(null!=c)return c;c=this.snapLimits.fillRatioForNavigationImprovements(g,d,a);return c>this.snapLimits.getScrollOutSnapToEntityRatio()?
null:1<c?g:this.getParentChapterOrOverview(a,g)}isInFreeZoomingCoverEditMode(a){if(null==a)return!1;switch(a.kind){case B.CoverEditModeKind.advanced:case B.CoverEditModeKind.insideAdvanced:return!0;case B.CoverEditModeKind.titleEditOnly:return!1;default:return D.Utils.assertNever(a)}}getEntityForScrollIn(a,b,c,d,g){c=this.clickScrollInCommon(c,b,a).apply(b.strategies().prioritizeTopic(g.getId(),a)).filter((c)=>this.shouldTriggerScrollGesture(c,b,d,a,0)).firstEntity();return null!=c&&f.CetModelEditor.isPlanetOrStack(c.getId(),
a)?this.getChapterOrFirstPageIfStack(a,c.getId()):c}clickScrollInCommon(a,b,c){return b.getEntitiesByWorldPoint(a).apply(b.strategies().general()).filter((a)=>a.is(f.HitTag.ENABLED)).apply(b.strategies().replaceCoverWithTopic(c))}getEntityForClickInPlaybackMode(a,b,c,d){return this.clickScrollInCommon(a,b,c).apply(b.strategies().prioritizeTopic(null==d?null:d.getId(),c,(a)=>a.isDef(ba))).firstEntity()}isTopicEntity(a,b){a=f.CetModelEditor.createTopicQuery(b).getTopicKind(a.getId());return a===f.TopicKind.Planet||
a===f.TopicKind.Stack}isEntityASelectedTopic(a,b,c){return null!=a&&this.isTopicEntity(a,c)&&1===b.length&&b[0]===a.getId()}getEntityForClickInEditMode(a,b,c,d,g,k,e=null){e=this.getEntityUnderPointInEditMode(a,b,c,d,!0,e);this.isEntityASelectedTopic(e,g,c)&&k===p.MouseInteractionType.Click&&(b=this.getEntityUnderPointInEditMode(a,b,c,d,!1,null),a.queryableInTitleEditOnlyMode(b)&&(e=b));return e}getEntityHitsUnderPointInEditMode(a,b,c,d,g=!0,k=null){b=b.screenPointToWorld(d);b=a.getEntitiesByWorldPoint(b).apply(a.strategies().general());
g&&(b=b.apply(a.strategies().replaceCoverWithTopic(c)));k&&(b=b.apply(F.SelectionModule.restrictToEntityAndCtrlPointsSQStrategy(k,c)));return b}getEntityUnderPointInEditMode(a,b,c,d,g=!0,k=null){return this.getEntityHitsUnderPointInEditMode(a,b,c,d,g,k).firstEntity()}getEntityForHoverInEditMode(a,b,c,d,g,k,e){if(!k)return null;k=this.getEntityUnderPointInEditMode(a,b,c,d,!0);if(!k)return null;1===g.length&&(e=null!=e&&e.isEditing()?g[0]:null,g=g[0]!==k.getId(),b=this.getEntityUnderPointInEditMode(a,
b,c,d,g,e),null!=b&&a.queryableInTitleEditOnlyMode(b)&&(k=b));return k}getEntityForDragStartInEditMode(a,b,c,d,g=!0,k=null){return this.getEntityHitsUnderPointInEditMode(a,b,c,d,g,k).apply(a.strategies().excludeEntitiesOnLogoLayer()).firstEntity()}};var C={};Object.defineProperty(C,"__esModule",{value:!0});C.DollyGripImpl=class{constructor(a){this.logger=J.LoggerModule.getLoggerManager().createLogger("prezi_cet.DollyGrip");this.stage=a;this.cameraNavigationBus=n.Bacon.newBus();this.cameraCancelledNavigationBus=
n.Bacon.newBus()}getDollyCameraNavigationStream(){return this.cameraNavigationBus}getDollyCancelledNavigationStream(){return this.cameraCancelledNavigationBus}executeAction(a,b,c,d,g){b=a.getEntityById(this.getPlaybackPath().getPathStepEntityId(c));var k=c.getAction()-1;b=b.getWrapper(h.CetModel.ID.PATH_STEP.W).getActions().getAt(k).getEntity();k=f.CetModelEditor.createPlaybackPathQuery(a).getTargetEntitiesForActionById(b.getId()).allIds;if(0<k.length){if(b.isDef(h.CetModel.ID.FADE_IN_OBJECT)||b.isDef(h.CetModel.ID.FADE_IN_OBJECTS))return a=
this.extendScopeOfPathAction(a,k),this.fadeIn(a,d,c);if(b.isDef(h.CetModel.ID.FADE_OUT_OBJECT)||b.isDef(h.CetModel.ID.FADE_OUT_OBJECTS))return a=this.extendScopeOfPathAction(a,k),this.fadeOut(a,d,c);if(b.isDef(h.CetModel.ID.ZOOM_TO_OBJECT)||b.isDef(h.CetModel.ID.ZOOM_TO_OVERVIEW))return this.navigateTo(k[0],d,g)}return this.navigationError(e.NavigationActionAnimationType.Fly,"unknown_pathaction_type ")}getStepIndexForPathStepId(a){const b=this.getPlaybackPath();let c=0,d=null;for(const g of b.getSteps().items())g===
a&&(d=c),c++;return d}getTargetEntityForActionById(a){a=this.stage.getModelScene().getEntityById(a);if(a.isDef(h.CetModel.ID.HAS_TARGET))return a.getWrapper(h.CetModel.ID.HAS_TARGET.W).getTarget();if(a.isDef(h.CetModel.ID.ZOOM_TO_OVERVIEW))return this.stage.getModelScene().getPreziW().getOverview().getId();this.logger.error({action:"noTargetOnAction",object:"action",trigger:"machine"});return null}findPrevFocusedEntity(a){let b=this.getPlaybackPath().getPathStepEntityId(a);var c=this.stage.getModelScene().getEntityById(b);
let d=c.isDef(h.CetModel.ID.FLY_TO_OBJECT)?c.getWrapper(h.CetModel.ID.FLY_TO_OBJECT.W).getTarget():this.stage.getModelScene().getPreziW().getOverview().getId();c=c.getWrapper(h.CetModel.ID.PATH_STEP.W);let g=this.getStepIndexForPathStepId(b),k=1;c.getActions().forEach((b)=>{let c=this.stage.getModelScene().getEntityById(b.getId()),e=this.getPlaybackPath().getPathPosition(g,k);(e.isBefore(a)||e.isSame(a))&&(c.isDef(h.CetModel.ID.ZOOM_TO_OBJECT)||c.isDef(h.CetModel.ID.ZOOM_TO_OVERVIEW))&&(d=this.getTargetEntityForActionById(b.getId()));
k++});return d}cameraEventCallback(a,b,c){c.onValue((c)=>{let d=new W(a,b);c.phase===e.NavigationActionAnimationPhase.End?this.cameraNavigationBus.push(d):this.cameraCancelledNavigationBus.push(d)})}onPathNavigationEvent(a){if(null!=a.getNavOptions()&&a.getNavOptions().cameraNavigationType===e.CameraNavigationType.NONE)a=new W(a,a.getNavigationMode()),this.cameraNavigationBus.push(a);else if(null==a.getToTargetId())this.cameraEventCallback(a,e.NavigationMode.JUMP,this.stage.flyToOverview());else if(null==
a.getToPos())this.cameraEventCallback(a,a.getNavigationMode(),this.stage.flyToId(a.getToTargetId()));else{let b=null!=a.getFromPos()&&a.getFromPos().getStep()===a.getToPos().getStep()&&a.getFromPos().getAction()+1===a.getToPos().getAction()&&0!==a.getToPos().getAction()?this.executeAction(this.stage.getModelScene(),a.getFromPos(),a.getToPos(),a.getNavigationMode(),a.getNavOptions()):this.navigateTo(this.findPrevFocusedEntity(a.getToPos()),a.getNavigationMode(),a.getNavOptions());this.cameraEventCallback(a,
a.getNavigationMode(),b)}}extendScopeOfPathAction(a,b){a=e.Cet.createTopicChildrenQuery(a);let c=[];for(let d of b)c.push(...a.getChildrenIdsVisibleOutside(d),d);return c}navigationError(a,b){this.logger.error({action:b,object:"dolly",trigger:"machine"});return n.Bacon.once({id:null,targetType:e.NavigationActionTargetType.ToId,animationType:a,phase:e.NavigationActionAnimationPhase.End})}navigateTo(a,b,c){null==a&&this.navigationError(e.NavigationActionAnimationType.Fly,"no_peer_to_fly_to_with_id ");
switch(b){case e.NavigationMode.NEW_TRANSITION:return null!=c?this.stage.snapToId(a,c.cameraNavigationType,c.speedMultiplyer):this.stage.flyToId(a);case e.NavigationMode.JUMP:return this.stage.focusToId(a,!1);case e.NavigationMode.INVERSE_ACCELERATE:return this.stage.inverseFlight(a,C.DollyGripImpl.SPEED_UP_FACTOR);case e.NavigationMode.INVERSE_ACCELERATE_2:return this.stage.inverseFlight(a,C.DollyGripImpl.SPEED_UP_JUMP);case e.NavigationMode.ACCELERATE:let d=n.Bacon.newBus();this.getCamera().accelerateCurrentTransition(C.DollyGripImpl.SPEED_UP_FACTOR);
this.getCamera().whenTransitionFinished((a)=>{d.push({targetType:e.NavigationActionTargetType.ToId,animationType:e.NavigationActionAnimationType.Fly,phase:a?e.NavigationActionAnimationPhase.End:e.NavigationActionAnimationPhase.Cancel});d.end()});return d;case e.NavigationMode.ACCELERATE_2:let g=n.Bacon.newBus();this.getCamera().accelerateCurrentTransition(C.DollyGripImpl.SPEED_UP_JUMP);this.getCamera().whenTransitionFinished((a)=>{g.push({targetType:e.NavigationActionTargetType.ToId,animationType:e.NavigationActionAnimationType.Fly,
phase:a?e.NavigationActionAnimationPhase.End:e.NavigationActionAnimationPhase.Cancel});g.end()});return g;default:throw Error("invalid NavigationMode");}}fireFadeForEntity(a,b){let c=null;for(let d of a)c=b?this.stage.fadeInPeerById(d):this.stage.fadeOutPeerById(d);return c}fadeIn(a,b){0===a.length&&this.navigationError(e.NavigationActionAnimationType.FadeIn,"no_peer_to_fly_to_with_id ");switch(b){case e.NavigationMode.NEW_TRANSITION:return this.fireFadeForEntity(a,!0);default:return n.Bacon.once({id:"",
targetType:e.NavigationActionTargetType.ToId,animationType:e.NavigationActionAnimationType.FadeIn,phase:e.NavigationActionAnimationPhase.End})}}fadeOut(a,b){0===a.length&&this.navigationError(e.NavigationActionAnimationType.FadeIn,"no_peer_to_fly_to_with_id ");switch(b){case e.NavigationMode.NEW_TRANSITION:return this.fireFadeForEntity(a,!1);default:return n.Bacon.once({id:"",targetType:e.NavigationActionTargetType.ToId,animationType:e.NavigationActionAnimationType.FadeOut,phase:e.NavigationActionAnimationPhase.End})}}getCamera(){return this.stage.getCamera()}getPlaybackPath(){return this.stage.getPathNavigator().getPath()}};
C.DollyGripImpl.SPEED_UP_FACTOR=2;C.DollyGripImpl.SPEED_UP_JUMP=1E4;class W{constructor(a,b){this.pathNavigationEvent=a;this.navigationMode=b}getPathNavigationEvent(){return this.pathNavigationEvent}toString(){return"CameraNavigationEvent: ["+(null==this.pathNavigationEvent?"":this.pathNavigationEvent.toString())+" ] ; mode: "+(null==this.navigationMode?"":e.NavigationMode[this.navigationMode])}}var O={};Object.defineProperty(O,"__esModule",{value:!0});O.Panner=class{constructor(a,b,c,d){this.startPanPos=
a;this.currentTopicId=b;this.camera=c;this.scene=d;this.calcPanningBorders();this.camera.startPanning(a)}panMove(a){this.panTarget=this.keepInBorder(a,this.hardPanTargetLimits);this.camera.setPanningTargetPosition(this.panTarget)}panEnd(){const a=this.keepInBorder(this.panTarget,this.softPanTargetLimits);this.camera.setPanningTargetPosition(a);this.camera.stopPanning()}keepInBorder(a,b){return{x:Math.min(Math.max(a.x,b.x_min),b.x_max),y:Math.min(Math.max(a.y,b.y_min),b.y_max)}}calcPanningBorders(){var a=
this.scene.getEntityById(this.currentTopicId);const b=this.camera.getMarginCorrectedViewport().getData();var c=f.CetModelEditor.createScreenBoundsCalculator(this.scene,this.camera),d=this.camera.getTransform();a=c.getMarginCorrectedViewportForEntity(a);c=.2*a.getWidth()/2;const g=.2*a.getHeight()/2;c=a.inflateXY(c,g).transform(d);d=a.transform(d);this.softPanTargetLimits=this.calcPanningTargetBorder(this.startPanPos,b,d);this.hardPanTargetLimits=this.calcPanningTargetBorder(this.startPanPos,b,c)}calcPanningTargetBorder(a,
b,c){let d=b.x-(c.getCenterX()-c.getWidthHalf());d=Math.max(0,d);let g=c.getCenterX()+c.getWidthHalf()-(b.x+b.width);g=Math.max(0,g);let e=b.y-(c.getCenterY()-c.getHeightHalf());e=Math.max(0,e);b=c.getCenterY()+c.getHeightHalf()-(b.y+b.height);b=Math.max(0,b);return{x_min:a.x-g,x_max:a.x+d,y_min:a.y-b,y_max:a.y+e}}};var H={};Object.defineProperty(H,"__esModule",{value:!0});H.CanvasInteraction=class{constructor(a,b,c,d,g,e,f,h,w,ca,l){this.playback=a;this.hitTest=b;this.scene=c;this.mouseInteractionStream=
d;this.keyboardEventStream=g;this.currentTopicStream=e;this.interactionHandler=f;this.zoomEventStream=h;this.isFollowerStream=w;this.modeStream=l;this.urlUtils=D.Utils.createUrlUtils();this.coverEditMode=null;this.logger=J.LoggerModule.getLoggerManager().createLogger("prezi_playback.CanvasInteraction");this.initMouseStream();this.mouseCursorStateActionBus=n.Bacon.newBus();this.recalculateEntityUnderMouseActionStreamOnPanning=n.Bacon.newBus();this.recalculateEntityUnderMouseActionStream=this.createRecalculateEntityUnderMouseActionStream(a.getStage().getCamera().getZoomingStream(),
this.recalculateEntityUnderMouseActionStreamOnPanning);this.mouseCursorStateStream=this.createMouseCursorStateStream(a.getStage().getCamera().getZoomingStream(),this.mouseCursorStateActionBus,this.mouseInteractionStream,this.modeStream,this.currentTopicStream,this.recalculateEntityUnderMouseActionStream);ca.onValue((a)=>this.coverEditMode=a);this.urlClickedStream=n.Bacon.newBus();this.interactionQuery=new K.InteractionQueryImpl}handleZoomEvent(a){this.playback.getStage().getCamera().cancelPanning();
let b;switch(a.zoomEvent){case q.ZoomEvent.ZOOM_IN:b=2;break;case q.ZoomEvent.ZOOM_OUT:b=3;break;case q.ZoomEvent.HOME:b=4;break;default:D.Utils.assertNever(a.zoomEvent)}this.interactionHandler.handleUserNavigation(this.scene,this.getStageQuery(),{x:0,y:0},0,b,a.currentTopicId)}getCurrentTopicActionStream(){return this.interactionHandler.getCurrentTopicActionStream()}getHoverStream(){return this.hoverStream}createMouseCursorStateStream(a,b,c,d,g,k){c=c.filterWithStream(d.map((a)=>a.kind!==l.EditorMode.edit)).filter((a)=>
a.type===p.MouseInteractionType.HoverMove);d=c.map(()=>null).merge(k);g=n.Bacon.combineWith3((a,b)=>{let c="default";b=this.scene.getEntityById(this.getEntityUnderPos(a,b));if(null!=b){const d=f.CetModelEditor.createTopicQuery(this.scene).getTopicKind(b.getId());if(d===f.TopicKind.Page||d===f.TopicKind.Stack||d===f.TopicKind.Planet||b.isDef(h.CetModel.ID.Z_ZOOM_AREA)||b.isDef(h.CetModel.ID.Z_VIDEO)||f.CetModelEditor.isClickableNextLogo(b.getId(),this.scene)||""!==this.getUrl(b,a.event.stagePos))c=
"pointer"}return{cursor:c}},c,g,k).sampledBy(d);a=a.map((a)=>{switch(a){case e.ZoomingEvent.ZoomIn:return{cursor:"zoom-in"};case e.ZoomingEvent.ZoomOut:return{cursor:"zoom-out"};case e.ZoomingEvent.NoZoom:return{cursor:"default"}}}).merge(b).merge(g);return n.Bacon.combineWith((a,b)=>a?{cursor:"default"}:b,this.isFollowerStream,a).changes()}createRecalculateEntityUnderMouseActionStream(a,b){return a.map((a)=>a===e.ZoomingEvent.NoZoom).filter((a)=>a).merge(b)}getMouseCursorStateStream(){return this.mouseCursorStateStream}getRecalculateEntityUnderMouseActionStream(){return this.recalculateEntityUnderMouseActionStream}mouseInteractionFilter(a){return(b)=>
b.interaction.type===a}mouseInteractionsFilter(a){return(b)=>-1<a.indexOf(b.interaction.type)}isObjectEvent(a){return null!=a.entityId}getEntityUnderPos(a,b){const c=this.getStageQuery();a=this.playback.getStage().getCamera().screenPointToWorld(a.event.stagePos);b=this.interactionQuery.getEntityForClickInPlaybackMode(a,c,this.scene,this.scene.getEntityById(b));return null==b?null:b.getId()}initMouseStream(){this.complexMouseStream=this.createComplexMouseStream().filterWithStream(this.isFollowerStream.map((a)=>
!a));this.hoverStream=this.complexMouseStream.filterWithStream(this.modeStream.map((a)=>a.kind!==l.EditorMode.edit)).filter((a)=>a.interaction.type===p.MouseInteractionType.HoverMove).map((a)=>a.entityId).skipDuplicates();var a=this.complexMouseStream.filter(this.mouseInteractionsFilter([p.MouseInteractionType.DragMove,p.MouseInteractionType.DragEnd])).filterWithStream(this.playback.getStage().getCamera().getTransitionStream().map((a)=>a===e.TransitionEvent.TransitionFinished).toProperty(!0)).map((a)=>
a.interaction);this.isPanningStream=a.map((a)=>a.type===p.MouseInteractionType.DragMove).skipDuplicates();const b=this.complexMouseStream.filter(this.mouseInteractionFilter(p.MouseInteractionType.Click)),c=this.complexMouseStream.map((a)=>a.interaction).filter((a)=>a.type===p.MouseInteractionType.Zoom);b.filter((a)=>this.isObjectEvent(a)).onValue((a)=>this.handleClickOnObject(a));b.filter((a)=>!this.isObjectEvent(a)).onValue((a)=>this.handleClickOnBg(a));this.currentTopicStream.combineAndSample((a,
b)=>({interaction:b,currentTopicId:a}),a).onValue(({interaction:a,currentTopicId:b})=>this.handlePan(a,b));const d=Z.PreziUAParser.isMac();n.Bacon.combineWith((a,b)=>({currentTopicId:a,smartZooming:d?!b.event.metaKey:!b.event.altKey,interaction:b}),this.currentTopicStream,c).sampledBy(c).filter(({interaction:a})=>0!==a.event.wheelDeltaY).onValue(({interaction:a,currentTopicId:b,smartZooming:c})=>this.handleMouseScroll(a,b,c));this.currentTopicStream.combineAndSample((a,b)=>({zoomEvent:b,currentTopicId:a}),
this.zoomEventStream).onValue((a)=>this.handleZoomEvent(a));a=this.currentTopicStream.combineAndSample((a,b)=>({zoomEvent:b,currentTopicId:a}),this.keyboardEventStream.filter((a)=>d?a.metaKey:a.altKey).filter((a)=>a.keyCode===p.Key.UP_ARROW||a.keyCode===p.Key.DOWN_ARROW).map((a)=>a.keyCode===p.Key.UP_ARROW?q.ZoomEvent.ZOOM_IN:q.ZoomEvent.ZOOM_OUT));a.onValue((a)=>this.handleKeyboardZoom(a));a.debounce(1E3).onValue(this.logKeyboardZoom)}createComplexMouseStream(){return this.currentTopicStream.combineAndSample((a,
b)=>{var c=this.getEntityUnderPos(b,a);var d=f.CetModelEditor.createTopicQuery(this.scene).getTopicKind(a);d=d===f.TopicKind.Stack||d===f.TopicKind.Planet||d===f.TopicKind.Page;return{interaction:b,currentTopicId:a,entityId:c,isLockedView:d}},this.mouseInteractionStream)}canZoomInOnEntity(a){return a.getDef()===h.CetModel.ID.Z_IMAGE||a.getDef()===h.CetModel.ID.Z_SHAPE||a.getDef()===h.CetModel.ID.Z_VIDEO||a.getDef()===h.CetModel.ID.Z_PDF||a.getDef()===h.CetModel.ID.Z_TEXT||a.getDef()===h.CetModel.ID.Z_CHART_PDF||
a.getDef()===h.CetModel.ID.Z_ZOOM_AREA}handleClickOnBg(a){this.playback.flyToObject(a.currentTopicId)}handlePan(a,b){switch(a.type){case p.MouseInteractionType.DragMove:null==this.panner&&(this.playback.getStage().getCamera().cancelZooming(),this.panner=new O.Panner(a.baseEvent.stagePos,b,this.playback.getStage().getCamera(),this.scene),this.mouseCursorStateActionBus.push({cursor:"-webkit-grabbing"}));this.panner.panMove(a.event.stagePos);break;case p.MouseInteractionType.DragEnd:null!=this.panner&&
(l.AppUtilsModule.getLogHelperUtils().canvasPan(this.logger,{actionIndex:this.playback.getCurrentActionIndex(),stepIndex:this.playback.getCurrentStepIndex(),totalStepNumber:this.playback.getStepCount()}),this.panner.panEnd()),this.mouseCursorStateActionBus.push({cursor:"default"}),this.panner=null,this.recalculateEntityUnderMouseActionStreamOnPanning.push(!0)}}getIsPanningStream(){return this.isPanningStream}handleMouseScroll(a,b,c){this.playback.getStage().getCamera().cancelPanning();let d=0<a.event.wheelDeltaY;
this.interactionHandler.handleUserNavigation(this.scene,this.getStageQuery(),a.event.stagePos,Math.abs(a.event.wheelDeltaY),d?0:1,b,c,this.coverEditMode)}handleKeyboardZoom({currentTopicId:a,zoomEvent:b}){this.playback.getStage().getCamera().cancelPanning();b=b===q.ZoomEvent.ZOOM_IN?0:1;this.interactionHandler.handleUserNavigation(this.scene,this.getStageQuery(),{x:0,y:0},3E3,b,a,!1,this.coverEditMode)}logKeyboardZoom(){J.avro.Avro.createDefaultLogger().logUseKeyboardShortcut({shortcut_type:"ZOOM_IN_OUT_OF_THE_CANVAS"})}getUrl(a,
b){b=this.playback.getStage().getCamera().screenPointToWorld(b);return this.hitTest.urlTest(a,b)}getUrlFromLogo(a){var b;return a.isDef(h.CetModel.ID.NEXT_LOGO_V1)?null===(b=a.getWrapper(h.CetModel.ID.NEXT_LOGO_V1.W))||void 0===b?void 0:b.getLinkUrl():null}handleClickOnObject(a){const b=this.scene.getEntityById(a.entityId),c=b.isDef(h.CetModel.ID.LOGO)||b.isDef(h.CetModel.ID.NEXT_LOGO_V1),d=c?this.getUrlFromLogo(b):this.getUrl(b,a.interaction.event.stagePos),g=""!==d;g||c||a.isLockedView&&!this.canZoomInOnEntity(b)&&
!f.CetModelEditor.isPlanetOrStack(b.getId(),this.scene)||this.interactionHandler.clickOn(b);g&&null!=d&&(this.urlClickedStream.push(d),window.open(this.getRedirectLink(d),"_blank"));b.isDef(h.CetModel.ID.Z_VIDEO)&&this.mouseCursorStateActionBus.push({cursor:"auto"})}getRedirectLink(a){return Y.isActive("js-redirect-links")?(a=this.urlUtils.asQueryString({target:a}),`${H.CanvasInteraction.REDIRECT_URL}${a}`):a}setSceneStream(a){a.onValue((a)=>{this.scene=a})}getStageQuery(){return this.scene.getPrezi().get(u.PlaybackModuleImpl.getStageQueryKey())}getUrlClickedStream(){return this.urlClickedStream}};
H.CanvasInteraction.REDIRECT_URL="https://prezi.com/url/";H.CanvasInteraction.MOUSE_DIST_CLICK_THRESHOLD=2;var P={};Object.defineProperty(P,"__esModule",{value:!0});const X=.05/1590;P.FreeZoomer=class{constructor(a,b){this.camera=a;this.scene=b;this.zoomEndTriggeringTimeOut=null}zoom(a,b,c,d,g){null!=this.zoomEndTriggeringTimeOut&&clearTimeout(this.zoomEndTriggeringTimeOut);const e=this.camera.getOngoingZoomTarget();null!=e&&this.currentDirection(this.camera.getTransform(),e)===c?this.updateZoom(a,
b,c,e,g):this.startZoom(a,b,c,d||this.scene.getPreziW().getOverview().getId(),g);this.zoomEndTriggeringTimeOut=setTimeout(()=>{this.zoomBackIfNeeded();this.zoomEndTriggeringTimeOut=null},100)}startZoom(a,b,c,d,g){this.setOuterZoomLimits(d);b=this.calcZoomTarget(a,b,c,g);this.currentZoomCenter=a;b=this.calculateLimitFix(b,this.hardZoomScaleLimit);this.camera.startFreeZoom(b)}updateZoom(a,b,c,d){b=X*b+1;c=d.scaleAroundPoint(a,c===e.ZoomingDirection.ZOOM_IN?b:1/b);this.currentZoomCenter=a;c=this.calculateLimitFix(c,
this.hardZoomScaleLimit);this.camera.updateFreeZoom(c)}calculateLimitFix(a,b){return a.getScale()<b?a.scaleAroundPoint(this.currentZoomCenter,b/a.getScale()):a}zoomBackIfNeeded(){const a=this.camera.getTransform(),b=this.calculateLimitFix(a,this.softZoomScaleLimit);a.getScale()<b.getScale()&&this.camera.startFreeZoom(b)}setOuterZoomLimits(a){this.softZoomScaleLimit=e.Cet.getTargetTransform(this.scene,a,this.camera.getMarginCorrectedViewport()).getScale();this.hardZoomScaleLimit=.8*this.softZoomScaleLimit}currentDirection(a,
b){return b.getScale()>a.getScale()?e.ZoomingDirection.ZOOM_IN:e.ZoomingDirection.ZOOM_OUT}calcZoomTarget(a,b,c,d=null){b=X*b+1;b=c===e.ZoomingDirection.ZOOM_IN?b:1/b;a=this.camera.getTransform().scaleAroundPoint(a,b);return null==d?a:this.keepInBounds(c,a,d)}keepInBounds(a,b,c){a=c.setRotation(0);var d=this.camera.getTransform().invert();d=E.Geometry.obbFromRect(this.camera.getMarginCorrectedViewport().getData()).transform(d);if(!c.union(d).equalsWithin(c,1E-5))return b;var g=b.invert();d=g.getRotationRad();
c=g.rotateRadAroundPoint(c.getCenter(),-d);g=E.Geometry.obbFromRect(this.camera.getMarginCorrectedViewport().getData()).transform(c);if(a.getHeight()>g.getHeight()&&a.getWidth()>g.getWidth()){let e=b=0;const f=a.getVertices();g=g.getVertices();g[0].x<f[0].x?b=f[0].x-g[0].x:g[1].x>f[1].x&&(b=f[1].x-g[1].x);g[0].y<f[0].y?e=f[0].y-g[0].y:g[2].y>f[2].y&&(e=f[2].y-g[2].y);return c.translate({x:b,y:e}).rotateRadAroundPoint(a.getCenter(),d).invert()}return b}};var Q={};Object.defineProperty(Q,"__esModule",
{value:!0});Q.InteractionHandler=class{constructor(a,b,c){this.stage=a;this.pathNavigator=c;this.logger=J.LoggerModule.getLoggerManager().createLogger("prezi_playback.InteractionHandler");this.snapLimits=new x.SnapLimits;this.camera=a.getCamera();this.currentTopicActionBus=n.Bacon.newBus();this.freeZoomer=new P.FreeZoomer(this.camera,b);this.interactionQuery=new K.InteractionQueryImpl}setEditModeStream(a){a.onValue((a)=>this.editorModeData=a)}getCurrentTopicActionStream(){return this.currentTopicActionBus}getCurrentTopic(a,
b){if(null==b)return a.getPreziW().getOverview().getEntity();if(a=a.getEntityById(b))return a;throw"Invalid current topic: "+a;}handleSceneChange(a,b,c){const d=f.CetModelEditor.createTopicQuery(c);if(a.kind===e.ChangeEventKind.Entity&&a.type===h.ChangeType.RemoveEntity&&a.entity.getId()===b.currentTopicId){a=null;for(let g of b.parentChapterIds)if(null!=c.getEntityById(g)&&(b=d.getTopicKind(g),b!==f.TopicKind.None)){b===f.TopicKind.Stack?(c=f.CetModelEditor.getPagesOfChapter(g,c),0<c.length&&(a=
c[0])):a=g;break}null!=a&&this.stage.snapToId(a,e.CameraNavigationType.SNAP_OUT,this.snapLimits.getCameraFlySpeedMultiplier())}}handleCameraNavigation(a,b){if(a.phase===e.NavigationActionAnimationPhase.Start&&a.animationType!==e.NavigationActionAnimationType.FadeIn&&a.animationType!==e.NavigationActionAnimationType.FadeOut&&!a.withoutCurrentTopicUpdate)if(null!=a.id&&null!=b.getEntityById(a.id)){var c=b.getEntityById(a.id);const d=f.CetModelEditor.createTopicQuery(b);d.getTopicKind(c.getId())!==f.TopicKind.None?
this.setCurrentTopic(c,a.animationType):e.Cet.visibility(c).isVisible()||(c=d.getTopicsWhereReachable(c,e.VisualBackgroundReachLevel.NONE),null!=c&&0<c.length&&(b=b.getEntityById(c[0]),this.setCurrentTopic(b,a.animationType)))}else this.setCurrentTopic(b.getPreziW().getOverview().getEntity(),a.animationType)}handleUserNavigation(a,b,c,d,g,e,f=!0,h=null){e=this.getCurrentTopic(a,e);this.stage.getCamera().setCameraOnPath(!1);switch(g){case 0:case 2:this.scrollIn(a,b,c,d,e,g,f,h);break;case 1:this.scrollOut(a,
b,c,d,e,f,h);break;case 3:this.zoomOut(a,b,e);break;case 4:this.zoomHome(a,e);break;default:D.Utils.assertNever(g)}}isOverviewOrTopicId(a,b){return f.CetModelEditor.isPlanetOrStack(a,b)||f.CetModelEditor.isPage(a,b)||a===b.getPreziW().getOverview().getId()}clickOn(a){let b=a.getId();if(f.CetModelEditor.isPlanetOrStack(b,this.stage.getModelScene())){let a=f.CetModelEditor.getPagesOfChapter(b,this.stage.getModelScene());0<a.length&&(b=a[0])}l.AppUtilsModule.getLogHelperUtils().zoomToObject(f.CetModelEditor.createLogHelper(this.stage.getModelScene()),
this.logger,l.ZoomToObjectLogTrigger.CLICK,a,this.stage.getModelScene(),{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()});a=this.snapLimits.getCameraFlySpeedMultiplier(!0);this.flyToObject(b,e.CameraNavigationType.SNAP_IN,a,!1)}scrollIn(a,b,c,d,g,k,h,z){let t=(new Date).getTime();this.stage.getCurrentCameraNavigation()===e.CameraNavigationType.SNAP_IN&&this.camera.isInTransition()?this.snapLimits.collectScrollEvent(t):
(this.snapLimits.addEventMeasurement(t),this.snapLimits.isTouchpadEaseDetected()||(this.snapLimits.resetScrollMeasurements(),b=this.interactionQuery.getEntityForScrollIn(a,b,this.camera.screenPointToWorld(c),this.camera,g),k=0===k?l.ZoomToObjectLogTrigger.SCROLL_IN:l.ZoomToObjectLogTrigger.ZOOM_IN,z=null!=z?z.topicId:null,h&&null!=b&&b.getId()!==z&&!this.isEntityPageOfChapter(a,z,b)&&b.getId()!==g.getId()?(l.AppUtilsModule.getLogHelperUtils().zoomToObject(f.CetModelEditor.createLogHelper(a),this.logger,
k,b,this.stage.getModelScene(),{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),c=b.getId(),g=this.snapLimits.getCameraFlySpeedMultiplier(c!==g.getId()&&this.isOverviewOrTopicId(c,a)),this.flyToObject(c,e.CameraNavigationType.SNAP_IN,g,!1)):(l.AppUtilsModule.getLogHelperUtils().canvasZoom(this.logger,k,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),
a=f.CetModelEditor.createScreenBoundsCalculator(a,this.camera),this.freeZoomer.zoom(c,d,e.ZoomingDirection.ZOOM_IN,g.getId(),a.getMarginCorrectedViewportForEntity(g))),this.snapLimits.updateScrollTime(t)))}isEntityPageOfChapter(a,b,c){a=this.parent(a,c);return!!a&&a.getId()===b}cameraCloseToOverview(a,b){return this.camera.getTransform().getScale()<1.02*e.Cet.getTargetTransform(a,b,this.camera.getViewport()).getScale()}scrollOut(a,b,c,d,g,k,h){const t=(new Date).getTime(),w=a.getPreziW().getOverview().getId();
this.stage.getCurrentCameraNavigation()===e.CameraNavigationType.SNAP_OUT&&this.camera.isInTransition()?this.snapLimits.collectScrollEvent(t):g.getId()===w&&this.cameraCloseToOverview(a,w)?this.freeZoomer.zoom(c,d,e.ZoomingDirection.ZOOM_OUT,g.getId()):(this.snapLimits.updateScrollTime(t),this.snapLimits.addEventMeasurement(t),this.snapLimits.isTouchpadEaseDetected()||(this.snapLimits.resetScrollMeasurements(),b=this.interactionQuery.getEntityForScrollOut(a,b,this.camera.screenPointToWorld(c),this.camera,
g,h),k&&null!=b?(l.AppUtilsModule.getLogHelperUtils().zoomToObject(f.CetModelEditor.createLogHelper(a),this.logger,l.ZoomToObjectLogTrigger.SCROLL_OUT,b,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),c=b.getId(),a=this.snapLimits.getCameraFlySpeedMultiplier(c!==g.getId()&&this.isOverviewOrTopicId(c,a)),this.flyToObject(c,e.CameraNavigationType.SNAP_OUT,a)):(l.AppUtilsModule.getLogHelperUtils().canvasZoom(this.logger,
l.ZoomToObjectLogTrigger.SCROLL_OUT,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()}),this.freeZoomer.zoom(c,d,e.ZoomingDirection.ZOOM_OUT,g.getId())),this.snapLimits.updateScrollTime(t)))}flyToObject(a,b=e.CameraNavigationType.FLY,c=1,d=!0){var g;f.CetModelEditor.setCameraAndPathFor({navigationControl:this.stage,speedMultiplyer:c,pathPosition:f.CetModelEditor.getPathPositionForTarget({allowForwardActions:(null===
(g=this.editorModeData)||void 0===g?void 0:g.kind)===l.EditorMode.edit,findClosestPathPositionWithTarget:d,navigationControl:this.stage,targetId:a})});switch(b){case e.CameraNavigationType.FOCUS:return this.stage.focusToId(a,!1);case e.CameraNavigationType.FLY:case e.CameraNavigationType.NONE:return this.stage.flyToId(a,c);case e.CameraNavigationType.SNAP_IN:case e.CameraNavigationType.SNAP_OUT:return this.stage.snapToId(a,b,c)}}zoomOut(a,b,c){if(this.currentZoomOutTargetId){b=this.parent(a,a.getEntityById(this.currentZoomOutTargetId));
if(null==b)return;f.CetModelEditor.isPage(c.getId(),a)&&(b=this.parent(a,b))}else if(this.shouldSnapToCurrentTopic(c,this.snapLimits.getZoomOutToCurrentBound())&&!this.currentZoomOutTargetId)b=c;else{b=this.parent(a,c);if(null==b)return;f.CetModelEditor.isPage(c.getId(),a)&&(b=this.parent(a,b))}null!=b&&(c=b.getId(),l.AppUtilsModule.getLogHelperUtils().zoomToObject(f.CetModelEditor.createLogHelper(a),this.logger,l.ZoomToObjectLogTrigger.ZOOM_OUT,b,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),
totalStepNumber:this.pathNavigator.getPath().getStepCount()}),this.flyToObject(c,e.CameraNavigationType.SNAP_OUT,this.snapLimits.getCameraFlySpeedMultiplier()).onValue(()=>{this.currentZoomOutTargetId=null}))}zoomHome(a,b){const c=a.getPreziW().getOverview().getEntity();l.AppUtilsModule.getLogHelperUtils().zoomToObject(f.CetModelEditor.createLogHelper(a),this.logger,l.ZoomToObjectLogTrigger.HOME,c,a,{stepIndex:this.getCurrentStepIndex(),actionIndex:this.getCurrentActionIndex(),totalStepNumber:this.pathNavigator.getPath().getStepCount()});
b.getId()===c.getId()&&this.cameraCloseToOverview(a,c.getId())?(a=e.Cet.world(c).getWorldAxisAlignedBounds(),b=E.Geometry.transform2dIdentity(),this.stage.flyToRectangle(b.scaleAroundPoint(a.getCenter(),1.1).transformRectangle(a),E.Geometry.transform2dIdentity(),.3,c.getId(),this.camera.getMarginCorrectedViewport()),setTimeout(()=>{this.stage.flyToOverview()},300)):this.stage.flyToOverview();this.pathNavigator.go(f.CetModelEditor.getPathPositionForTarget({navigationControl:this.stage,targetId:c.getId()}),
{cameraNavigationType:e.CameraNavigationType.NONE,speedMultiplyer:1})}setCurrentTopic(a,b){this.currentTopicActionBus.push({newCurrentTopic:a.getId(),navigationType:b})}shouldSnapToCurrentTopic(a,b){if(null==a)return!1;a=this.snapLimits.fillRatio(a,this.camera);return b<a}getCurrentActionIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getAction()}getCurrentStepIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getStep()}parent(a,
b){if(b.isDef(h.CetModel.ID.OVERVIEW))return null;b=a.getEntityById(e.Cet.createHierarchyQuery(a).getParentId(b));return null==b?a.getPreziW().getOverview().getEntity():b}};var R={};Object.defineProperty(R,"__esModule",{value:!0});R.NavigationAndSceneEventHandler=class{constructor(a){this.interactionHandler=a;this.sceneChangeBus=n.Bacon.newBus();this.currentTopicAndParents={currentTopicId:null,parentChapterIds:null}}_collectParents(a,b){a=e.Cet.createHierarchyQuery(this.scene).getAncestorEntities(a).filter((a)=>
f.CetModelEditor.isPlanetOrStack(a,this.scene));a=0<a.length?a[0]:null;return null==a?b.concat([this.scene.getPreziW().getOverview().getId()]):this._collectParents(a,b.concat([a]))}collectParents(a){return null==a?null==this.scene.getPreziW().getOverview()?[]:[this.scene.getPreziW().getOverview().getId()]:this._collectParents(a,[])}setupSceneChangeHandler(a){a.onValue((a)=>{null!=this.scene&&(this.currentTopicAndParents={currentTopicId:a,parentChapterIds:this.collectParents(a)})});this.sceneChangeBus.onValue((a)=>
{if(null!=this.scene)for(let b of a)this.interactionHandler.handleSceneChange(b,this.currentTopicAndParents,this.scene,this.getStageQuery());else throw"CameraNavigationHandler:Scene is not initialized";})}setCameraNavigationStream(a){a.onValue((a)=>{if(null!=this.scene)this.interactionHandler.handleCameraNavigation(a,this.scene,this.getStageQuery());else throw"CameraNavigationHandler:Scene is not initialized";})}setSceneStream(a){a.onValue((a)=>{this.scene=a})}setEntityChangeStream(a){this.sceneChangeBus.plug(a)}getStageQuery(){return this.scene.getPrezi().get(u.PlaybackModuleImpl.getStageQueryKey())}};
var G={};Object.defineProperty(G,"__esModule",{value:!0});G.PlaybackVisibilityQuery=class{setupVisibilityOfPathActionTarget(a,b,c,d,g,e,f){if(a.isBefore(b)||a.isSame(b)){if(c.isDef(h.CetModel.ID.FADE_OUT_OBJECT)||c.isDef(h.CetModel.ID.FADE_OUT_OBJECTS))f(d,!1),this.setTarget(g,d,e);if(c.isDef(h.CetModel.ID.FADE_IN_OBJECT)||c.isDef(h.CetModel.ID.FADE_IN_OBJECTS))f(d,!0),this.setTarget(g,d,e)}if(a.isAfter(b)&&(a=g[d],null==a||e<a)){if(c.isDef(h.CetModel.ID.FADE_OUT_OBJECT)||c.isDef(h.CetModel.ID.FADE_OUT_OBJECTS))f(d,
!0),this.setTarget(g,d,e);if(c.isDef(h.CetModel.ID.FADE_IN_OBJECT)||c.isDef(h.CetModel.ID.FADE_IN_OBJECTS))f(d,!1),this.setTarget(g,d,e)}}setTarget(a,b,c){let d=a[b];if(null==d||c<d)a[b]=c}collectVisibilitiesOnPathPosition(a,b,c){const d=f.CetModelEditor.createPlaybackPathQuery(a),g=e.Cet.createHierarchyQuery(a);let k={},h=0;a.getPreziW().getPath().forEach((a)=>{let f=0;a.getActions().forEach((a)=>{const t=e.Cet.pathPositionFromStepIndex_killMe(h,f+1);a=a.getEntity();var w=d.getTargetEntitiesForActionById(a.getId()).allIds;
for(let d of w){this.setupVisibilityOfPathActionTarget(t,b,a,d,k,0,c);w=g.getDescendantEntities([d]);for(let e of w)w=g.getChildParentDistance(e,d),this.setupVisibilityOfPathActionTarget(t,b,a,e,k,w,c)}f++});h++});a.getPreziW().getBackground().getLayers().forEach((a)=>{a=a.getEntity();c(a.getId(),!0)})}createGeneralVisibilityFilter(a){return(b)=>{b=a.getEntityById(b);return!b.get(h.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER)&&b.getId()!==a.getPreziW().getOverview().getId()}}createPathVisibilityFilter(a,
b){const c={};this.collectVisibilitiesOnPathPosition(b,a,(a,b)=>c[a]=b);return(a)=>{a=c[a];return null==a||a}}};var L={};Object.defineProperty(L,"__esModule",{value:!0});(function(a){a[a.Next=0]="Next";a[a.Previous=1]="Previous";a[a.Jump=2]="Jump";a[a.Resume=3]="Resume"})(L.PathNavigationAction||(L.PathNavigationAction={}));class da{constructor(a,b,c,d,g,e,f,h){this.onEndHandlers=[];this.pathNavigationEndBus=n.Bacon.newBus();this.hoverStream=n.Bacon.newBus();this.logger=J.LoggerModule.getLoggerManager().createLogger("prezi_playback.PlaybackImpl");
this.stage=a;this.mainHitTest=c;this.sceneBuilder=d;this.baseScene=g;this.playbackScene=e;this.pathNavigator=f;this.dollyGrip=q.PlaybackModule.createDollyGrip(a);this.speedMeter=h;this.interactionHandler=new Q.InteractionHandler(a,g,f);this.navigationAndSceneEventHandler=new R.NavigationAndSceneEventHandler(this.interactionHandler);this.pathNavigator.getPathNavigationStream().onValue((a)=>{this.stage.getCamera().setCameraOnPath(!0);this.dollyGrip.onPathNavigationEvent(a)});a=this.dollyGrip.getDollyCameraNavigationStream().map((a)=>
({cancelled:!1,cameraNavigationEvent:a}));b=this.dollyGrip.getDollyCancelledNavigationStream().map((a)=>({cancelled:!0,cameraNavigationEvent:a}));a=a.merge(b);this.pathNavigationEndBus.plug(a.map((a)=>a.cancelled));this.pathNavigator.setAsyncCallback(a.map((a)=>a.cameraNavigationEvent.getPathNavigationEvent()));this.dollyGrip.getDollyCameraNavigationStream().merge(this.dollyGrip.getDollyCancelledNavigationStream()).onValue((a)=>{a=a.getPathNavigationEvent();let b=[];for(;0<this.onEndHandlers.length;){let c=
this.onEndHandlers.pop();c(a.getToPos())||b.push(c)}this.onEndHandlers=b});this.pathNavigator.getPathNavigationStream().onValue((a)=>{var b,c;null!=this.speedMeter&&this.speedMeter.setCurrentPathStepIndex(null!==(c=null===(b=a.getToPos())||void 0===b?void 0:b.getStep())&&void 0!==c?c:-1);if(null!=this.onStepHandler)this.onStepHandler({currentPathPosition:a.getToPos(),focusedObjectId:a.getToTargetId(),stepCount:a.getPath().getStepCount(),actionCount:null==a.getToPos()?0:a.getPath().getActionCount(a.getToPos().getStep())})})}seekTo(a){this.getPathNavigator().seekTo(a);
if(this.onStepHandler)this.onStepHandler({currentPathPosition:a,focusedObjectId:this.getPathNavigator().getCurrentTargetId(),stepCount:this.getPathNavigator().getPath().getStepCount(),actionCount:this.getPathNavigator().getPath().getActionCount(a.getStep())})}getPathNavigationEndStream(){return this.pathNavigationEndBus}getCurrentTopicActionStream(){return this.canvasInteraction.getCurrentTopicActionStream()}reset(a=!0){a&&this.playbackScene.reset(!0);this.pathNavigator.setScene(this.stage.getModelScene());
this.initPosition(!1)}initPosition(a){if(0===this.pathNavigator.getPath().getStepCount())this.stage.focusToOverview(!1),this.pathNavigationEndBus.push(!1);else if(a){a=f.CetModelEditor.createPlaybackPathQuery(this.stage.getModelScene());const b=this.stage.getModelScene().getPreziW().getOverview().getId();a=a.getClosestSuitablePathPosition(this.pathNavigator.getPath().getPathPosition(0,0),b);this.pathNavigator.initWithPosition(null!=a?a:this.pathNavigator.getPath().getPathPosition(0,0))}else this.pathNavigator.initWithPosition(this.pathNavigator.getPath().getStartPoint())}resume(){let a=
this.stage.getPathNavigator().getPath(),b=null;this.stage.getCamera().isCameraOnPath()&&(b=this.pathNavigator.getCurrentPosition());null!=b&&(this.pathNavigator.go(b),this.stage.getCamera().setCameraOnPath(!0));0===a.getStepCount()&&(this.stage.focusToOverview(!1),this.stage.getCamera().setCameraOnPath(!0))}resumeFromInfo(){if(0===this.stage.getPathNavigator().getPath().getStepCount())this.stage.focusToOverview(!1);else{let a=this.pathNavigator.getCurrentPosition().getStep();this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,
0))}this.stage.getCamera().setCameraOnPath(!0)}initInteractionStreams(a,b,c,d,e,f,h,z,w){this.interactionHandler.setEditModeStream(f);this.canvasInteraction=new H.CanvasInteraction(this,this.mainHitTest,this.playbackScene,b,c,d,this.interactionHandler,e,h,z,f);this.hoverStream.plug(this.canvasInteraction.getHoverStream());this.stage.getCamera().setCameraOnPath(!0);a=a.getShortcutStream(p.ShortcutAction.GO_TO_EDIT_MODE).map(()=>({newMode:l.EditorMode.edit,trigger:"esc"}));b=f.sampledBy(this.canvasInteraction.getUrlClickedStream()).map((a)=>
a.kind===l.EditorMode.playback?{newMode:l.EditorMode.playback,linkClickedFlow:!0,presenterNotesFlow:a.presenterNotesFlow,showTopmenu:a.showTopmenu,shouldGoFullscreen:!1,shouldSeekPathToStart:!1,trigger:"link clicked"}:null).filter((a)=>null!=a);this.changeModeActionStream=n.Bacon.mergeAll([a,b]);this.handleKeyboardNavigationInEditMode(f,w,c)}getHoverStream(){return this.hoverStream}handleKeyboardNavigationInEditMode(a,b,c){c=c.filter((a)=>a.type===p.KeyboardEventType.KEYDOWN&&!a.shiftKey&&!a.altKey&&
!a.ctrlKey&&!a.metaKey&&-1<[p.Key.LEFT_ARROW,p.Key.RIGHT_ARROW,p.Key.UP_ARROW,p.Key.DOWN_ARROW,p.Key.PAGE_UP,p.Key.PAGE_DOWN].indexOf(a.keyCode));n.Bacon.combineWith3((a,b,c)=>({mode:a,selection:b.allEntityIds,keyCode:c.keyCode}),a,b,c).sampledBy(c).filter(({selection:a,mode:b})=>0===a.length&&b.kind===l.EditorMode.edit).onValue(({keyCode:a})=>{-1<[p.Key.LEFT_ARROW,p.Key.UP_ARROW,p.Key.PAGE_UP].indexOf(a)?this.navigateBackward(()=>{},void 0,!0):-1<[p.Key.RIGHT_ARROW,p.Key.DOWN_ARROW,p.Key.PAGE_DOWN].indexOf(a)&&
this.navigateForward(()=>{},void 0,!0)})}getChangeModeActionStream(){return this.changeModeActionStream}getCameraNavigationStream(){return this.dollyGrip.getDollyCameraNavigationStream()}getMouseCursorStateStream(){return this.canvasInteraction.getMouseCursorStateStream()}getRecalculateEntityUnderMouseActionStream(){return this.canvasInteraction.getRecalculateEntityUnderMouseActionStream()}navigateForward(a,b,c){l.AppUtilsModule.getLogHelperUtils().flyToNextStep(this.logger);b=this.stage.getCamera().isCameraOnPath()?
this.pathNavigator.next(c):this.pathNavigator.resume();this.waitForPathPosition_KILLME(a,b)}navigateBackward(a,b,c){l.AppUtilsModule.getLogHelperUtils().flyToPreviousStep(this.logger);b=this.stage.getCamera().isCameraOnPath()?this.pathNavigator.prev(c):this.pathNavigator.resume();this.waitForPathPosition_KILLME(a,b)}flyToStep(a,b){l.AppUtilsModule.getLogHelperUtils().flyToStep(this.logger,a);this.waitForPathPosition_KILLME(b,this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,0)))}isEntityVisibleAtPathPosition(a,
b){let c=!0;(new G.PlaybackVisibilityQuery).collectVisibilitiesOnPathPosition(this.playbackScene,b,(b,e)=>{a===b&&(c=e)});return c}isEntityVisibleAtCurrentPathPosition(a){return this.isEntityVisibleAtPathPosition(a,this.pathNavigator.getCurrentPosition())}getClosestPathPositionWhereVisible(a){var b=this.pathNavigator.getCurrentPosition();const c=this.pathNavigator.getPath().getAllPathPositions();let d=0;for(var e=0;e<c.length;e++)if(c[e].isSame(b)){d=e;break}for(b=0;;b++){e=d+b;if(e<c.length){var f=
c[e];if(this.isEntityVisibleAtPathPosition(a,f))return f}f=d-b;if(0<=f){const b=c[f];if(this.isEntityVisibleAtPathPosition(a,b))return b}if(e>=c.length&&0>f)return null}}flyToStepAction(a,b,c){this.waitForPathPosition_KILLME(c,this.pathNavigator.go(this.pathNavigator.getPath().getPathPosition(a,b)))}jumpToStepAction(a,b){this.pathNavigator.jump(this.pathNavigator.getPath().getPathPosition(a,b))}waitForPathPosition_KILLME(a,b){if(null!=a&&null!=b){var c=(c)=>b.isSame(c)?(a(),!0):!1;!this.pathNavigator.isMoving()&&
this.pathNavigator.getCurrentPosition().isSame(b)?a():this.onEndHandlers.push(c)}}addOnEndHandler(a){this.onEndHandlers.push(()=>a())}flyToOverview(){l.AppUtilsModule.getLogHelperUtils().flyToOverview(this.logger);return this.stage.flyToOverview()}flyToObject(a,b=e.CameraNavigationType.FLY,c=1){return this.interactionHandler.flyToObject(a,b,c)}flyModeToNavMode(a){switch(a){case q.FlyMode.START_NEW_FLY:return e.NavigationMode.NEW_TRANSITION;case q.FlyMode.JUMP:return e.NavigationMode.JUMP}return null}hasNext(){return!this.pathNavigator.getPath().getPathCalculator().isLast(this.pathNavigator.getCurrentPosition())}hasPrevious(){return!this.pathNavigator.getPath().getPathCalculator().isFirst(this.pathNavigator.getCurrentPosition())}setOnStep(a){this.onStepHandler=
a}getStepCount(){return this.pathNavigator.getPath().getStepCount()}getAnimationCountOnSteps(){return[]}getPathPositionsForNavigation(){return this.pathNavigator.getPath().getPathStepPositionsForNavigation()}getPathStepPositionsWithAudio(){return this.pathNavigator.getPath().getPathStepPositionsWithAudio()}getActionCount(a){return this.pathNavigator.getPath().getActionCount(a)}getCurrentStepIndex(){return null==this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getStep()}getCurrentActionIndex(){return null==
this.pathNavigator.getCurrentPosition()?0:this.pathNavigator.getCurrentPosition().getAction()}getCurrentPathPosition(){var a;return null!==(a=this.pathNavigator.getCurrentPosition())&&void 0!==a?a:this.pathNavigator.getPath().getPathPosition(0,0)}getStartPosition(){return this.pathNavigator.getPath().getStartPoint()}getIsPanningStream(){return this.canvasInteraction.getIsPanningStream()}getStage(){return this.stage}createDollyGrip(a){return new C.DollyGripImpl(a)}getScene(){return this.playbackScene}getBaseScene(){return this.baseScene}getSceneBuilder(){return this.sceneBuilder}getPathNavigator(){return this.pathNavigator}peerAtScreenCoordinates_bdd(a){a=
this.playbackScene.getPrezi().get(u.PlaybackModuleImpl.getStageQueryKey()).getEntityIdUnderPoint(this.stage.getCamera().screenPointToWorld(a));return null==a?null:this.playbackScene.getEntityById(a)}setSceneStream(a){this.canvasInteraction.setSceneStream(a);this.navigationAndSceneEventHandler.setSceneStream(a)}setEntityChangeStream(a){this.navigationAndSceneEventHandler.setEntityChangeStream(a)}setCameraNavigationStream(a){this.navigationAndSceneEventHandler.setCameraNavigationStream(a)}setupSceneChangeHandler(a){this.navigationAndSceneEventHandler.setupSceneChangeHandler(a)}isVideoInFocus(){var a=
this.stage.getEntityIdInFocus();a=this.stage.getModelScene().getEntityById(a);return null!=a&&a.isDef(h.CetModel.ID.Z_VIDEO)}}L.PlaybackImpl=da;var m={};Object.defineProperty(m,"__esModule",{value:!0});m.logoEntityId="logo-system-entity";m.LogoSystem=class{constructor(a,b,c,d,e){this.renderingAssetManager=d;this.oldLogoAlpha=.8;this.windowSizeChanged=!1;a.onValue((a)=>{null!=a&&this.logoType!==a&&(this.logoType=a,this.isDirty=!0,e.markViewChanged())});b.onValue((a)=>{this.hoveredEntityIds=a;e.markViewChanged()});
c.onValue((a)=>{this.windowSize=a;this.windowSizeChanged=!0;e.markViewChanged()})}manageLogoHoverState(a){const b=this.isLogoOrLogoDecorator(a,this.hoveredEntityIds)?1:.8;a=a.getEntityById(m.logoEntityId);const c=this.currentLinkUrl;null!=a&&b!==this.oldLogoAlpha&&c&&(this.visHelper.setVisibility(a,!0,b),this.oldLogoAlpha=b)}isLogoOrLogoDecorator(a,b){if(null==b||1!==b.length)return!1;b=b[0];a=a.getEntityById(b);if(null==a)return!1;if(b===m.logoEntityId)return!0;a=a.get(F.SelectionModule.getDecoratorKey());
return null!=a&&1===a.ownerIds.length&&a.ownerIds[0]===m.logoEntityId}changesPdomComponents(){return!1}getName(){return"LogoSystem"}init(a){this.visHelper=a.getTweener().createVisibilityAnimationHelper("logo");this.nextLogoTracker=a.getEntityList().startNewTracking("LogoSystem-logo-media-asset",[h.CetModel.ID.MEDIA_ASSET.ONLINE_ASSET_URL,h.CetModel.ID.NEXT_LOGO_V1.LINK_URL,h.CetModel.ID.NEXT_LOGO_V1.BACKGROUND_COLOR,h.CetModel.ID.NEXT_LOGO_V1.BACKGROUND_ALPHA],(a)=>a.getId()!==m.logoEntityId)}reset(){}update(a){if(this.isDirty)switch(this.logoType){case A.PreziLogoType.None:a.getEntityList().deleteEntity(m.logoEntityId);
break;case A.PreziLogoType.Watermark:this.updateWatermark(a);break;case A.PreziLogoType.DocumentBased:this.updateDocumentBasedLogo(a,!0);break;default:D.Utils.assertNever(this.logoType)}this.manageLogoHoverState(a);this.logoType===A.PreziLogoType.DocumentBased&&a.getEntityList().forChangedMutableEntities(()=>{this.updateDocumentBasedLogo(a)},this.nextLogoTracker);this.manageLogoSizeCategory(a);this.windowSizeChanged=this.isDirty=!1}updateDocumentBasedLogo(a,b=!1){if(null==this.getLogoMediaAssetUrl(a))a.getEntityList().deleteEntity(m.logoEntityId);
else{let c=a.getEntityById(m.logoEntityId);const d=a.getPreziW().getNextLogo(),e=null!=d&&d.is(h.CetModel.ID.NEXT_LOGO_V1),f=null!=c&&(e&&!c.isDef(h.CetModel.ID.NEXT_LOGO_V1)||!e&&c.isDef(h.CetModel.ID.NEXT_LOGO_V1));f&&(a.getEntityList().deleteEntity(m.logoEntityId),c=null);null==c&&(c=e?this.createNextLogoEntity(a):this.createClassicLogoEntity(a));e?this.updateNextLogoProperties(a,d,c,b||f):this.updateClassicLogoProperties(a,c)}}updateWatermark(a){const b=this.getLogoMediaAssetUrl(a);this.currentLinkUrl=
"https://www.prezi.com";this.currentBackgroundColor=E.Geometry.colorFromRGB(1,1,1);this.currentBackgroundAlpha=1;let c=a.getEntityById(m.logoEntityId);var d=a.getPreziW().getNextLogo();d=null!=d&&d.is(h.CetModel.ID.NEXT_LOGO_V1);null==c||d||(a.getEntityList().deleteEntity(m.logoEntityId),c=null);null==c&&(c=this.createNextLogoEntity(a));this.updateLogoMediaAsset(a,c,b)}createNextLogoEntity(a){a=a.getEntityList().createEntity(m.logoEntityId);a.set(e.Cet.getDefComponentKey(),h.CetModel.ID.NEXT_LOGO_V1);
a.setComponent(r.CetRendererModule.getDrawComponentKey(),r.CetRendererModule.createNextLogoDrawComponent());a.setComponent(r.CetRendererModule.getZOrderComponentKey(),r.CetRendererModule.createZOrderComponent(0,r.LayerType.LogoLayer));this.visHelper.setVisibility(a,!0,.8);return a}createClassicLogoEntity(a){a=a.getEntityList().createEntity(m.logoEntityId);a.set(e.Cet.getDefComponentKey(),h.CetModel.ID.LOGO);a.setComponent(r.CetRendererModule.getDrawComponentKey(),r.CetRendererModule.createLogoDrawComponent());
a.setComponent(r.CetRendererModule.getZOrderComponentKey(),r.CetRendererModule.createZOrderComponent(0,r.LayerType.LogoLayer));this.visHelper.setVisibility(a,!0,1);return a}updateClassicLogoProperties(a,b){const c=this.getLogoMediaAssetUrl(a);this.updateLogoMediaAsset(a,b,c)}updateNextLogoProperties(a,b,c,d=!1){var e,f;if(null===b||void 0===b?0:b.is(h.CetModel.ID.NEXT_LOGO_V1)){const g=null===c||void 0===c?void 0:c.getMutableWrapper(h.CetModel.ID.NEXT_LOGO_V1.W),k=d||b.getOnlineAssetUrl()!==this.currentOnlineAssetUrl,
l=d||b.getLinkUrl()!==this.currentLinkUrl;d=d||(null===(e=b.getBackgroundColor())||void 0===e?void 0:e.getRGBInt())!==(null===(f=this.currentBackgroundColor)||void 0===f?void 0:f.getRGBInt())||b.getBackgroundAlpha()!==this.currentBackgroundAlpha;k&&(this.currentOnlineAssetUrl=this.getLogoMediaAssetUrl(a));l&&(this.currentLinkUrl=b.getLinkUrl());d&&(this.currentBackgroundColor=b.getBackgroundColor(),this.currentBackgroundAlpha=b.getBackgroundAlpha());k?this.updateLogoMediaAsset(a,c,this.currentOnlineAssetUrl):
(l&&g.setLinkUrl(this.currentLinkUrl),d&&(g.setBackgroundColor(this.currentBackgroundColor),g.setBackgroundAlpha(this.currentBackgroundAlpha)))}}updateLogoMediaAsset(a,b,c){this.renderingAssetManager.imageAssetFromUrl(c,b.getId()).then((b)=>{a.requestNoDomBatchUpdate((a)=>{a=a.getEntityById(m.logoEntityId);if(null!=a&&!a.isDisposed()){var c=a.getMutableWrapper(h.CetModel.ID.NEXT_LOGO_V1.W);if(null===c||void 0===c?0:c.is(h.CetModel.ID.NEXT_LOGO_V1))c.setLinkUrl(this.currentLinkUrl),c.setBackgroundColor(this.currentBackgroundColor),
c.setBackgroundAlpha(this.currentBackgroundAlpha);a=e.Cet.mutableDraw(a);a.kind!==r.DrawComponentKind.logo&&a.kind!==r.DrawComponentKind.nextLogo||a.setAsset(b)}})})}getLogoMediaAssetUrl(a){switch(this.logoType){case A.PreziLogoType.DocumentBased:const b=a.getPreziW().getNextLogo();a=(null===b||void 0===b?0:b.is(h.CetModel.ID.NEXT_LOGO_V1))?b:a.getPreziW().getLogo();return null===a||void 0===a?void 0:a.getOnlineAssetUrl();case A.PreziLogoType.Watermark:return q.getWatermarkAssetUrl();case A.PreziLogoType.None:return null;
default:throw D.Utils.assertNever(this.logoType);}}manageLogoSizeCategory(a){if(this.windowSizeChanged||this.isDirty)if(a=a.getEntityById(m.logoEntityId),null!=a&&(a=e.Cet.mutableDraw(a),null!=a&&a.kind===r.DrawComponentKind.nextLogo)){const b=null==this.windowSize||1280>=this.windowSize.width&&720>=this.windowSize.height;switch(this.logoType){case A.PreziLogoType.DocumentBased:a.updateSizeCategory(b?r.LogoSizeCategory.documentBasedSmall:r.LogoSizeCategory.documentBasedLarge);break;case A.PreziLogoType.Watermark:a.updateSizeCategory(b?
r.LogoSizeCategory.preziLogoSmall:r.LogoSizeCategory.preziLogoLarge);break;case A.PreziLogoType.None:break;default:throw D.Utils.assertNever(this.logoType);}}}};var S={};Object.defineProperty(S,"__esModule",{value:!0});S.PathVisibilitySystemImpl=class{constructor(){this.prevVisibleEntities=[];this.pathVisibilityKey=e.Cet.getPathVisibilityKey()}track(a){null==this.pathVisibilityTracker&&(this.pathVisibilityTracker=a.getEntityList().startNewTracking("PathVisibilityTracker",[this.pathVisibilityKey],
()=>!0));a.getEntityList().forChangedMutableEntities((a)=>{for(let b of a)this.prevVisibleEntities.push(b.getId())},this.pathVisibilityTracker)}clearTracker(a){a.getEntityList().forChangedMutableEntities(()=>{},this.pathVisibilityTracker)}process(a,b){this.track(b);const c=[];b.getPreziW().getZObjects().forEach((a)=>c.push(a.getId()));b.getPreziW().getBackground().getLayers().forEach((a)=>c.push(a.getId()));this.prevVisibleEntities.forEach((a)=>{a=b.getEntityById(a);null!=a&&a.discardOwnComponent(this.pathVisibilityKey)});
a=new G.PlaybackVisibilityQuery;const d=b.getPrezi().get(e.Cet.getCurrentPathPositionKey()),g=a.createPathVisibilityFilter(d,b),f=c.filter((a)=>g(a));b.getEntityList().forEach((a)=>{(a.isDef(h.CetModel.ID.LOGO)||a.isDef(h.CetModel.ID.NEXT_LOGO_V1))&&f.push(a.getId())});f.forEach((a)=>b.getEntityById(a).set(this.pathVisibilityKey,{isEnabled:!0,alpha:1}));this.clearTracker(b);this.prevVisibleEntities=f}getName(){return"PathVisibilitySystem"}reset(){}select(){return!0}getTriggerKeys(){return[h.CetModel.getNewEntityCompKey(),
h.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER,e.Cet.getCurrentPathPositionKey(),h.CetModel.ID.PREZI.PATH,h.CetModel.ID.PREZI.EDITOR_PATH,...h.CetModel.ID.EDITOR_PATH.getFields(),h.CetModel.ID.PATH_STEP.ACTIONS,h.CetModel.ID.EDITOR_PATH_STEP.ACTIONS,h.CetModel.ID.HAS_TARGET.TARGET]}changesPdomComponents(){return!1}};var T={};Object.defineProperty(T,"__esModule",{value:!0});T.PlaybackVisibilitySystemImpl=class{constructor(){this.playbackVisibilityKey=u.PlaybackModuleImpl.getPlaybackVisibilityKey()}process(a,
b){b=(new G.PlaybackVisibilityQuery).createGeneralVisibilityFilter(b);for(let c of a)b(c.getId())?c.set(this.playbackVisibilityKey,{isEnabled:!0,alpha:1}):c.set(this.playbackVisibilityKey,{isEnabled:!1,alpha:0}),c.isDef(h.CetModel.ID.Z_ZOOM_AREA)&&c.set(this.playbackVisibilityKey,{isEnabled:!0,alpha:0})}getName(){return"PlaybackVisibilitySystem"}getVisibilityKey(){return this.playbackVisibilityKey}reset(){}select(a){return a.hasComponent(r.CetRendererModule.getDrawComponentKey())}getTriggerKeys(){return[h.CetModel.getNewEntityCompKey(),
h.CetModel.ID.POSSIBLY_PLACEHOLDER.IS_PLACEHOLDER]}changesPdomComponents(){return!1}};var y={};Object.defineProperty(y,"__esModule",{value:!0});y.StageQueryImpl=class{constructor(a,b,c,d,e){this.scene=a;this.stage=b;this.applicationMode=e;c.onValue((a)=>this.coverEditMode=a);d.onValue((a)=>this.currentTopicId=a)}strategies(){return f.CetModelEditor.createStageQueryStrategyFactory(this.scene,this.applicationMode)}getEntityIdUnderPoint(a,b=!0,c=null){a=this.getEntitiesByWorldPoint(a);c?a=a.apply(F.SelectionModule.restrictToEntityAndCtrlPointsSQStrategy(c,
this.scene)):(a=a.apply(this.strategies().general()),b&&(a=a.apply(this.strategies().replaceCoverWithTopic(this.scene))));a=a.apply(this.strategies().excludeEntitiesOnLogoLayer());return a.firstEntityId()}getSurroundingTopic(){var a=this.stage.getStageCamera().viewportInWorld();let b=E.Geometry.obbFromRect(a.getData());var c=this.scene.getEntityList().asArray().filter((a)=>{const c=f.CetModelEditor.createTopicQuery(this.scene).getTopicKind(a.getId());return(c===f.TopicKind.Page||c===f.TopicKind.Stack||
c===f.TopicKind.Planet)&&e.Cet.world(a).getWorldBounds().containsRect(b)});a=-1;let d=null;for(let b of c)if(c=e.Cet.world(b).getWorldBounds(),c=c.getWidth()*c.getHeight(),null==d||c<a)a=c,d=b;return null==d?this.scene.getPreziW().getOverview().getEntity():d}queryableInTitleEditOnlyMode(a){return a.isDef(h.CetModel.ID.Z_TEXT)}isChildOfCurrentTopic(a){if(!e.Cet.hasPdomComponent(a))return!1;const b=e.Cet.createHierarchyQuery(this.scene);return this.scene.getEntityById(b.getParentOrOverview(a)).getId()===
this.currentTopicId}borderAreaHit(a,b){var c=1/this.stage.getStageCamera().getTransform().getScale();c=Math.ceil(c*y.StageQueryImpl.CLICKABLE_BORDER_WIDTH);return!e.Cet.world(a).getWorldBoundingShape().inflate(-c).containsPoint(b)&&e.Cet.world(a).getWorldBoundingShape().containsPoint(b)}getEntitiesByWorldArea(a){let b=this.getViewEntitiesInRectangle(a.getBounds());return this.getStageQueryResult(b,[this.createGeneralTagger(),this.createWorldAreaTagger(a)])}filterNonEnabled(a){return a.filter((a)=>
(null==a.get(e.Cet.getEntityHittestDisabledKey())||!a.get(e.Cet.getEntityHittestDisabledKey()))&&(null==a.get(e.Cet.getTemporaryEntityHittestDisabledKey())||0>=a.get(e.Cet.getTemporaryEntityHittestDisabledKey())))}getLogoUnderPoint(a){a=this.stage.getStageCamera().getTransform().transformPoint(a);const b=this.scene.getEntityById(m.logoEntityId);if(null==b)return[];const c=f.CetModelEditor.createScreenBoundsCalculator(this.scene,this.stage.getStageCamera()).getLogoBoundsInScreen(this.scene,b.getId());
return null!=c&&c.containsPoint(a)?[b]:[]}getViewEntitiesUnderPoint(a){return[...this.getLogoUnderPoint(a),...this.filterNonEnabled(this.stage.getHitTest().getViewEntitiesUnderPoint(this.scene.getPreziW(),a))]}getViewEntitiesInRectangle(a){return this.filterNonEnabled(this.stage.getHitTest().getViewEntitiesInRectangle(this.scene.getPreziW(),a))}getEntitiesByWorldPoint(a){let b=this.getViewEntitiesUnderPoint(a);return this.getStageQueryResult(b,[this.createGeneralTagger(),this.createWorldPointTagger(a)])}tag(a){a=
a.map((a)=>this.scene.getEntityById(a));return this.getStageQueryResult(a,[this.createGeneralTagger()])}isVisibleOutsideOnASubtopic(a){const b=e.Cet.createTopicChildrenQuery(this.scene);return b.isVisibleOutside(a.getId())?(a=b.getChildReferer(a.getId()),null!=a&&this.isChildOfCurrentTopic(this.scene.getEntityById(a))):!1}isEntityReachable(a){if(a.isDef(h.CetModel.ID.LOGO)||a.isDef(h.CetModel.ID.NEXT_LOGO_V1))return!0;const b=e.Cet.createTopicChildrenQuery(this.scene);var c=b.getBehavior(a.getId());
if(null==this.coverEditMode){var d=e.Cet.createHierarchyQuery(this.scene),g=this.scene.getEntityById(d.getParentOrOverview(a));d=this.scene.getEntityById(d.getParentOrOverview(g)).getId()===this.currentTopicId;return this.isChildOfCurrentTopic(a)&&c===e.TopicChildBehavior.Content||d&&(c===e.TopicChildBehavior.Cover||c===e.TopicChildBehavior.Surface||c===e.TopicChildBehavior.Visual)}switch(this.coverEditMode.kind){case B.CoverEditModeKind.titleEditOnly:case B.CoverEditModeKind.advanced:return a.getId()!==
this.coverEditMode.topicId&&(this.isChildOfCurrentTopic(a)&&c===e.TopicChildBehavior.Content||this.isVisibleOutsideOnASubtopic(a));case B.CoverEditModeKind.insideAdvanced:const h=f.CetModelEditor.createTopicQuery(this.scene).getTopicKind(this.currentTopicId)===f.TopicKind.Page;c=(a)=>{const c=h?b.getChildReferer(this.currentTopicId):null;return null!=c?b.getBehaviorReferer(a.getId(),e.TopicChildBehavior.Visual)===c:!1};d=e.Cet.createHierarchyQuery(this.scene);g=this.scene.getEntityById(d.getParentOrOverview(a));
d=this.scene.getEntityById(d.getParentOrOverview(g)).getId()===this.currentTopicId;return this.isChildOfCurrentTopic(a)&&b.isVisibleInside(a.getId())||c(a)||d&&b.isVisibleOutside(a.getId());default:return D.Utils.assertNever(this.coverEditMode)}}calculateZoomAreaTag(a){var b=this.stage.getStageCamera(),c=E.Geometry.obbFromRect(b.getMarginCorrectedViewport().getData()).transform(b.getTransform().invert());b=c.getWidth();c=c.getHeight();const d=e.Cet.world(a).getWorldBounds().getWidth();a=e.Cet.world(a).getWorldBounds().getHeight();
return c-.001<a||b-.001<d?f.HitTag.ENCLOSING_ZOOM_AREA:f.HitTag.SMALLER_ZOOM_AREA}createGeneralTagger(){return(a)=>{let b=[];e.Cet.hasPdomComponent(a)&&b.push(f.HitTag.HAS_PDOM_COMPONENT);this.isEntityReachable(a)&&b.push(f.HitTag.REACHABLE_IN_DOCUMENT);f.CetModelEditor.isPage(a.getId(),this.scene)&&b.push(f.HitTag.PAGE);var c=a.get(F.SelectionModule.getDecoratorKey());null!=c&&c.interactionType!==F.InteractionType.none&&b.push(f.HitTag.INTERACTIVE_DECORATOR);(c=a.isDef(h.CetModel.ID.LOGO)||a.isDef(h.CetModel.ID.NEXT_LOGO_V1))&&
b.push(f.HitTag.LOGO);(c||e.Cet.visibility(a).isVisible())&&b.push(f.HitTag.VISIBLE);(c||e.Cet.visibility(a).isEnabled())&&b.push(f.HitTag.ENABLED);c=e.Cet.createTopicChildrenQuery(this.scene);const d=f.CetModelEditor.createTopicQuery(this.scene),g=e.Cet.createHierarchyQuery(this.scene),k=(a,b)=>{if(null==a)return!1;switch(a.kind){case B.CoverEditModeKind.advanced:case B.CoverEditModeKind.insideAdvanced:return!0;case B.CoverEditModeKind.titleEditOnly:return this.queryableInTitleEditOnlyMode(b);default:return D.Utils.assertNever(a)}};
c.hasBehavior(a.getId(),e.TopicChildBehavior.Cover)&&(b.push(f.HitTag.COVER),k(this.coverEditMode,a)&&c.getBehaviorReferer(a.getId(),e.TopicChildBehavior.Cover)===this.coverEditMode.topicId&&b.push(f.HitTag.COVER_OF_COVER_EDITED_TOPIC));if(c.hasBehavior(a.getId(),e.TopicChildBehavior.Visual)||c.hasBehavior(a.getId(),e.TopicChildBehavior.Surface)){b.push(f.HitTag.VISUALLIKE);const e=c.getChildReferer(a.getId());k(this.coverEditMode,a)&&e===this.coverEditMode.topicId&&b.push(f.HitTag.VISUALLIKE_OF_COVER_EDITED_TOPIC);
(e===this.currentTopicId||d.getTopicKind(this.currentTopicId)===f.TopicKind.Page&&e===g.getParentId(this.scene.getEntityById(this.currentTopicId)))&&b.push(f.HitTag.VISUALLIKE_OF_CURRENT_TOPIC)}e.Cet.createHierarchyQuery(this.scene).isZTopicContainer(a.getId())&&(b.push(f.HitTag.Z_TOPIC_CONTAINER),0===c.getChildrenIdsVisibleOutside(a.getId()).length&&b.push(f.HitTag.Z_TOPIC_CONTAINER_WITHOUT_COVER_AND_VISUAL));(a.isDef(h.CetModel.ID.Z_ARROW)||a.isDef(h.CetModel.ID.Z_LINE))&&b.push(f.HitTag.LINE_ARROW);
a.isDef(h.CetModel.ID.Z_ZOOM_AREA)&&(b.push(f.HitTag.ZOOM_AREA),b.push(this.calculateZoomAreaTag(a)));this.isObjectTooLarge(a)?b.push(f.HitTag.TOO_LARGE):this.isObjectTooSmall(a)&&b.push(f.HitTag.TOO_SMALL);return b}}createWorldPointTagger(a){return(b)=>{let c=[];var d=this.stage.getHitTest();if(b.isDef(h.CetModel.ID.LOGO)||b.isDef(h.CetModel.ID.NEXT_LOGO_V1))return[f.HitTag.CLICKED_ENCLOSELY,f.HitTag.CLICKED_IN_WORLD_BOUNDS];let g=e.Cet.transform(b).getWorldToLocal().transformPoint(a);d.enclosePoint(this.stage.getStageCamera(),
b,g)&&(c.push(f.HitTag.CLICKED_ENCLOSELY),d.hitTest(this.stage.getStageCamera(),b,g)&&c.push(f.HitTag.CLICKED_PRECISELY));e.Cet.world(b).getWorldBoundingShape().containsPoint(a)&&c.push(f.HitTag.CLICKED_IN_WORLD_BOUNDS);this.borderAreaHit(b,a)&&c.push(f.HitTag.CLICKED_IN_BORDER_AREA);d=e.Cet.createTopicChildrenQuery(this.scene);null!=this.coverEditMode&&this.coverEditMode.kind!==B.CoverEditModeKind.insideAdvanced&&e.Cet.hasPdomComponent(b)&&null!=a&&!d.isVisibleOutside(b.getId())&&d.getChildReferer(b.getId())!==
this.coverEditMode.topicId&&(b=this.scene.getEntityById(this.coverEditMode.topicId),d=f.CetModelEditor.createBoundsCalculator(this.scene).getWorldBoundsForInteraction(this.coverEditMode.topicId,f.TextBoundsOptions.TextBox),null!=b&&d.containsPoint(a)&&c.push(f.HitTag.EXTERNAL_OBJECT_INTERSECTING_COVER_EDIT_BOUNDS));return c}}createWorldAreaTagger(a){return(b)=>{let c=[];b=e.Cet.world(b).getWorldBounds();b.containsRect(a)&&c.push(f.HitTag.CONTAINS_WORLD_AREA);b.intersects(a)&&c.push(f.HitTag.INTERSECT_WORLD_AREA);
return c}}getStageQueryResult(a,b){this.sortEntitiesByAncestryAndZIndex(a);a=a.map((a)=>{let c=[];for(let d=0;d<b.length;++d)c=c.concat(b[d](a));return f.CetModelEditor.createEntityHit({entity:a,hitTags:c,zIndex:e.Cet.zOrder(a).getZIndex(),layerIndex:r.CetRendererModule.calcLayerInt(e.Cet.zOrder(a).getZLayer())})});return f.CetModelEditor.createStageQueryResult(a)}sortEntitiesByAncestryAndZIndex(a){a.sort((a,c)=>{const b=e.Cet.createHierarchyQuery(this.scene);return-1!==b.getAncestorEntities(a.getId()).indexOf(c.getId())?
-1:-1!==b.getAncestorEntities(c.getId()).indexOf(a.getId())?1:r.CetRendererModule.getEntityOrder(a,c)})}isObjectTooLarge(a){if(!this.objectLockingEnabled(a,!0))return!1;var b=this.stage.getStageCamera().getViewport();const c=this.stage.getScreenBounds(a),d=Math.min(c.getWidth()/b.getWidth(),c.getHeight()/b.getHeight());b=Math.max(c.getWidth()/b.getWidth(),c.getHeight()/b.getHeight());a=a.isDef(h.CetModel.ID.Z_TEXT)?y.StageQueryImpl.LOCK_TOO_BIG_SHORTED_TEXT_DIMENSION_RATIO:y.StageQueryImpl.LOCK_TOO_BIG_SHORTED_DIMENSION_RATIO;
return d>a||b>y.StageQueryImpl.LOCK_TOO_BIG_LONGER_DIMENSION_RATIO}isObjectTooSmall(a){if(!this.objectLockingEnabled(a,!1))return!1;const b=this.stage.getStageCamera().getViewport();a=this.stage.getScreenBounds(a);return Math.max(a.getWidth()/b.getWidth(),a.getHeight()/b.getHeight())<y.StageQueryImpl.LOCK_TOO_SMALL_RATIO}objectLockingEnabled(a,b){const c=e.Cet.hasPdomComponent(a);a=e.Cet.createHierarchyQuery(this.scene).getParentId(a);a=f.CetModelEditor.isPage(a,this.scene);return c&&(b||!a)}};y.StageQueryImpl.CLICKABLE_BORDER_WIDTH=
20;y.StageQueryImpl.LOCK_TOO_SMALL_RATIO=.02;y.StageQueryImpl.LOCK_TOO_BIG_SHORTED_DIMENSION_RATIO=.6;y.StageQueryImpl.LOCK_TOO_BIG_SHORTED_TEXT_DIMENSION_RATIO=1;y.StageQueryImpl.LOCK_TOO_BIG_LONGER_DIMENSION_RATIO=1.8;var U={};Object.defineProperty(U,"__esModule",{value:!0});U.StageQuerySystem=class{constructor(a,b,c,d,e){this.zoomingStage=a;this.coverEditModeProperty=b;this.currentTopicIdStream=c;this.applicationMode=d;this.stageQueryKey=e}process(a,b){null!=b.getPrezi()&&(a=new y.StageQueryImpl(b,
this.zoomingStage,this.coverEditModeProperty,this.currentTopicIdStream,this.applicationMode),b.getPrezi().set(this.stageQueryKey,a))}select(a){return a.isDef(h.CetModel.ID.PREZI)}getTriggerKeys(){return[h.CetModel.getNewEntityCompKey()]}getName(){return"StageQuerySystem"}changesPdomComponents(){return!1}};var V={};Object.defineProperty(V,"__esModule",{value:!0});V.ThumbnailVisibilitySystem=class{constructor(a,b){this.visibilityKey=b;this.prevVisibleEntities=[];a.onValue((a)=>this.currentTopicId=a)}init(){}reset(){}getName(){return"ThumbnailVisibility"}update(a){if(null!=
this.currentTopicId&&null!=a.getEntityById(this.currentTopicId)){var b=new G.PlaybackVisibilityQuery;this.prevVisibleEntities.map((b)=>{b=a.getEntityById(b);null!=b&&b.discardOwnComponent(this.visibilityKey)});var c=f.CetModelEditor.createTopicQuery(a).getReachableEntities(this.currentTopicId,e.VisualBackgroundReachLevel.ALL_VISUALS_AND_BACKGROUND),d=a.getPrezi().get(e.Cet.getCurrentPathPositionKey()),g=b.createGeneralVisibilityFilter(a),k=b.createPathVisibilityFilter(d,a);b=c.filter((b)=>g(b)&&k(b)&&
!a.getEntityById(b).isDef(h.CetModel.ID.Z_ZOOM_AREA));b.forEach((b)=>a.getEntityById(b).set(this.visibilityKey,{isEnabled:!0,alpha:1}));this.prevVisibleEntities=b}}changesPdomComponents(){return!1}};var M={};Object.defineProperty(M,"__esModule",{value:!0});M.TopicAnimator=class{constructor(a,b,c,d,e,h,l,n){this.makeVisible=a;this.makeInvisible=b;this.visHelper=c;this.forceInstantPaging=h;this.newEntities=l;this.scene=n;this.topicQuery=f.CetModelEditor.createTopicQuery(n);this.prevTopicKind=null!=
d?this.topicQuery.getTopicKind(d):null;this.currTopicKind=this.topicQuery.getTopicKind(e);const g=new Set(b),k=new Set([]);a.forEach((a)=>{g.has(a)&&k.add(a)});this.makeVisible=a.filter((a)=>!k.has(a));this.makeInvisible=b.filter((a)=>!k.has(a))}animate(a){this.forceImmediate=a||this.scene.getTweener().getTweenMode()===e.TweenMode.IMMEDIATE;this.makeInvisible.forEach((a)=>{const b=this.scene.getEntityById(a);a=this.computeFadeOutData(a);this.visHelper.fadeOut(b,a)});this.makeVisible.forEach((a)=>
{const b=this.scene.getEntityById(a);a=this.computeFadeInData(a);this.visHelper.fadeIn(b,a)})}computeFadeInData(a){return this.forceImmediate||-1!==this.newEntities.indexOf(a)?e.Cet.getAnimationData(e.AnimationType.INSTANT):this.prevTopicKind===f.TopicKind.Page&&this.currTopicKind===f.TopicKind.Page?this.forceInstantPaging?e.Cet.getAnimationData(e.AnimationType.INSTANT):e.Cet.getAnimationData(e.AnimationType.PAGE_FADE_IN):e.Cet.getAnimationData(e.AnimationType.OVERVIEW_FADE_IN)}computeFadeOutData(a){return this.forceImmediate||
-1!==this.newEntities.indexOf(a)?e.Cet.getAnimationData(e.AnimationType.INSTANT):this.prevTopicKind===f.TopicKind.Page&&this.currTopicKind===f.TopicKind.Page?this.forceInstantPaging?e.Cet.getAnimationData(e.AnimationType.INSTANT):e.Cet.getAnimationData(e.AnimationType.PAGE_FADE_OUT):e.Cet.getAnimationData(e.AnimationType.OVERVIEW_FADE_OUT)}};var N={};Object.defineProperty(N,"__esModule",{value:!0});N.TopicVisibilitySystem=class{constructor(a,b,c,d,e){this.forceInstantPaging=a;this.refreshable=d;this.topicOverlayAnimator=
e;this.firstUpdateAfterReset=!1;this.prevLetterBoxing=null;this.dirty=!1;this.currentTopicNavigation={newCurrentTopic:null,navigationType:null};c.onValue(()=>{this.refreshable.markViewChanged()});b.onValue((a)=>{null!=a&&null!=a.newCurrentTopic&&null!=this.currentTopicNavigation&&this.currentTopicNavigation.newCurrentTopic!==a.newCurrentTopic&&(this.dirty||(this.prevTopic=this.currentTopicNavigation.newCurrentTopic),this.currentTopicNavigation=a,this.dirty=!0)})}init(a){null==this.visHelper&&(this.visHelper=
a.getTweener().createVisibilityAnimationHelper("TopicVisibilitySystem"),this.newZObjects=a.getEntityList().startNewTracking("PD-newObjects",[h.CetModel.getNewEntityCompKey()],(a)=>null!=e.Cet.zOrder(a)&&!this.visHelper.hasVisibilityKey(a)),this.outlineContent=a.getEntityList().startNewTracking("TopicVisibility-outline-content",[f.CetModelEditor.getShowContentKey()],()=>!0),this.behaviorChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-topic-child-change",[h.CetModel.ID.TOPIC_CHILD.BEHAVIOUR],
()=>!0),this.childrenChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-children-change",[h.CetModel.ID.HAS_CHILDREN.CHILDREN_PARENT,h.CetModel.ID.TOPIC_CHILD.CHILD_PARENT],()=>!0),this.smartStructureChangeTracker=a.getEntityList().startNewTracking("TopicVisibility-topic-smartStructureChangeTracker-change",[h.CetModel.ID.SMART_STRUCTURE.CHILDREN_PARENT],()=>!0),null!=this.topicOverlayAnimator&&this.topicOverlayAnimator.init(a))}createAnimatorForNewTopics(a,b,c){const d=f.CetModelEditor.createTopicQuery(a).getReachableEntities(b,
e.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>null!=a.getEntityById(b)).filter((a)=>0<=c.indexOf(a));return new M.TopicAnimator(d,[],this.visHelper,null,b,this.forceInstantPaging,c,a)}isExistingEntity(a,b){return null!=b&&null!=a.getEntityById(b)}createAnimatorForTopicNavigation(a,b,c){var d=f.CetModelEditor.createTopicQuery(a);const g=this.isExistingEntity(a,b)?d.getReachableEntities(b,e.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>this.isExistingEntity(a,b)):[];d=this.isExistingEntity(a,
c)?d.getReachableEntities(c,e.VisualBackgroundReachLevel.ALL_VISUALS).filter((b)=>null!=a.getEntityById(b)).filter((a)=>a!==b):[];return 0<g.length||0<d.length?new M.TopicAnimator(g,d,this.visHelper,c,b,this.forceInstantPaging,[],a):null}handleBehaviorChange(a,b){const c=f.CetModelEditor.createTopicQuery(b).getReachableEntities(this.currentTopicNavigation.newCurrentTopic,e.VisualBackgroundReachLevel.ALL_VISUALS),d=(a)=>{const d=b.getEntityById(a);0<=c.indexOf(a)?this.visHelper.isVisible(d)||this.visHelper.show(d):
this.visHelper.isVisible(d)&&this.visHelper.hide(d)};a.forEach((a)=>d(a))}manageOutlineContent(a){const b=a.get(f.CetModelEditor.getShowContentKey()),{visibility:c,alpha:d}=null!=b&&b?{visibility:!0,alpha:.5}:{visibility:!1,alpha:0};this.visHelper.setVisibility(a,c,d)}update(a){if(null!=this.currentTopicNavigation&&null!=a.getEntityById(this.currentTopicNavigation.newCurrentTopic)){a.getEntityList().forChangedMutableEntities((b)=>{b=b.filter((a)=>e.Cet.hasPdomComponent(a));b.forEach((a)=>this.visHelper.hide(a));
b=this.createAnimatorForNewTopics(a,this.currentTopicNavigation.newCurrentTopic,b.map((a)=>a.getId()));null!=b&&b.animate(this.currentTopicNavigation.navigationType===e.NavigationActionAnimationType.Focus)},this.newZObjects);a.getEntityList().forChangedMutableEntities((b)=>{b=b.filter((a)=>e.Cet.hasPdomComponent(a)).map((a)=>a.getMutableWrapper(h.CetModel.ID.TOPIC_CHILD.W).getChild());this.handleBehaviorChange(b,a)},this.behaviorChangeTracker);a.getEntityList().forChangedMutableEntities((b)=>{for(let c of b)e.Cet.hasPdomComponent(c)&&
c.isDef(h.CetModel.ID.Z_TOPIC_CONTAINER)&&(b=c.getMutableWrapper(h.CetModel.ID.Z_TOPIC_CONTAINER.W).getMutableTopic(),b.getEntity().isDef(h.CetModel.ID.HAS_TOPIC_CHILDREN)&&(b=b.getEntity().getMutableWrapper(h.CetModel.ID.HAS_TOPIC_CHILDREN.W),this.handleBehaviorChange([...b.getMutableTopicChildren()].map((a)=>a.getChild()),a)))},this.smartStructureChangeTracker);a.getEntityList().forChangedMutableEntities((b)=>{b=b.map((a)=>a.getMutableWrapper(h.CetModel.ID.HAS_CHILDREN.W).getEntity().getId());this.handleBehaviorChange(b,
a)},this.childrenChangeTracker);a.getEntityList().forChangedMutableEntities((b)=>{for(let c of b)this.manageOutlineContent(c,a)},this.outlineContent);var b=e.Cet.parseAspectRatio(a.getPreziW().getAspectRatio()).letterBoxing;if(this.prevTopic!==this.currentTopicNavigation.newCurrentTopic||this.prevLetterBoxing!==b){const c=this.createAnimatorForTopicNavigation(a,this.currentTopicNavigation.newCurrentTopic,this.prevLetterBoxing!==b?null:this.prevTopic);null!=c&&c.animate(this.currentTopicNavigation.navigationType===
e.NavigationActionAnimationType.Focus)}null!=this.topicOverlayAnimator&&(e.Cet.parseAspectRatio(a.getPreziW().getAspectRatio()).letterBoxing?this.topicOverlayAnimator.decorate(a,this.currentTopicNavigation.newCurrentTopic,this.prevLetterBoxing!==b?null:this.prevTopic,!this.firstUpdateAfterReset):this.topicOverlayAnimator.reset(a));this.prevTopic=this.currentTopicNavigation.newCurrentTopic;this.prevLetterBoxing=b;this.prevTopic=this.currentTopicNavigation.newCurrentTopic}this.firstUpdateAfterReset=
this.dirty=!1}getName(){return"TopicVisibilitySystem"}changesPdomComponents(){return!1}reset(a){this.dirty=!1;const b=this.createAnimatorForTopicNavigation(a,null,this.currentTopicNavigation.newCurrentTopic);null!=b&&b.animate(!0);this.currentTopicNavigation={newCurrentTopic:this.currentTopicNavigation.newCurrentTopic,navigationType:e.NavigationActionAnimationType.Focus};this.prevLetterBoxing=this.prevTopic=null;null!=this.topicOverlayAnimator&&this.topicOverlayAnimator.reset(a);this.firstUpdateAfterReset=
!0}};var I={};Object.defineProperty(I,"__esModule",{value:!0});I.TriggeringVisibilityAggregatorSystemImpl=class{constructor(a,b,c,d){this.keys=a;this.invisibilityKeys=b;this.processDelegate=c;this.tweener=d}getWorkingKeys(){return this.tweener.getVisibilityKeys().concat(this.keys)}process(a){for(let c of a){var b=this.getWorkingKeys();a=!0;let d=1;for(let e of b)b=c.get(e),null!=b&&(a=a&&b.isEnabled,d=Math.min(d,b.alpha));for(let e of this.invisibilityKeys)b=c.get(e),null==b&&(b={isEnabled:!1,alpha:0}),
a=a&&b.isEnabled,d=Math.min(d,b.alpha);this.processDelegate(c,d,a)}}select(a){return a.hasComponent(r.CetRendererModule.getDrawComponentKey())}getTriggerKeys(){return[h.CetModel.getNewEntityCompKey()].concat(this.getWorkingKeys()).concat(this.invisibilityKeys)}getName(){return"VisibilityAggregatorSystem"}reset(){}init(a){null==this.tweener&&(this.tweener=a.getTweener())}changesPdomComponents(){return!1}};var u={};Object.defineProperty(u,"__esModule",{value:!0});u.PlaybackModuleImpl=class{static createDollyGrip(a){return new C.DollyGripImpl(a)}static createInteractionQuery(){return new K.InteractionQueryImpl}static createPlayback(a,
b){a.getMainStage().setScene(b,b);return new L.PlaybackImpl(a.getMainStage(),a.getMainStage().getCamera(),a.getMainStage().getHitTest(),a.getSceneBuilder(),a.getBaseScene(),b,a.getMainStage().getPathNavigator(),a.getSpeedMeter())}static createPlaybackScene(a,b,c,d,g,h,t,p,w){g=a.getMainStage().getRenderer().createChannel(c);var k=d.map((a)=>null==a?null:a.newCurrentTopic);const q=a.getSceneBuilder();var m=q.getSystemFactory();u.PlaybackModuleImpl.componentFactory=a.createComponentFactory();const v=
new S.PathVisibilitySystemImpl,x=new T.PlaybackVisibilitySystemImpl;var z=x.getVisibilityKey();d=n.Bacon.combineWith((a,b)=>null==a||b===l.EditorMode.playback||b===l.EditorMode.view||b===l.EditorMode.follow||b===l.EditorMode.templateChooser||b===l.EditorMode.animationPreview?a:{newCurrentTopic:a.newCurrentTopic,navigationType:e.NavigationActionAnimationType.Focus},d,h).sampledBy(d).toProperty(null);d=new N.TopicVisibilitySystem(!1,d,b.getEntityIdInFocusStream(),b,null);z=m.createShaperSystem(new I.TriggeringVisibilityAggregatorSystemImpl([z],
[e.Cet.getPathVisibilityKey()],(a,b,c)=>e.Cet.updateVisibility(a).setAlpha(b).setEnabled(c)));h=m.createShaperSystem(new I.TriggeringVisibilityAggregatorSystemImpl([],[],(a,b,c)=>{e.Cet.updateCommentVisibility(a).setEnabled(c).setAlpha(b)}));const y=F.SelectionModule.createCustomSelectionSystem(n.Bacon.never().toProperty(aa.emptySelectionInfo()),n.Bacon.never(),p,n.Bacon.never().toProperty([]),n.Bacon.never(),k,n.Bacon.never().toProperty(null),n.Bacon.never().toProperty(null),n.Bacon.never().toProperty(null),
n.Bacon.never().toProperty(!1),n.Bacon.never().toProperty(null),n.Bacon.never().toProperty(null),b.getCamera(),a.getDomLayerManager(),null,b),A=m.createBoundCalculationSystem(),B=m.createWorldGeometrySystem();p=f.CetModelEditor.createHideDegenerateConnectorsFixerSystem(m);const C=u.PlaybackModuleImpl.createLogoSystem(t,w,a.getCetUI().getSizeProperty(),b);t=[d,C,z,h];w=[A,B,p];k=[m.createShaperSystem(u.PlaybackModuleImpl.createStageQuerySystem(b,n.Bacon.never().toProperty(),k,f.ApplicationMode.View,
u.PlaybackModuleImpl.getStageQueryKey())),m.createInitializerSystem(m.createInvisibleFrameSystem(()=>r.CetRendererModule.createZInvisibleFrameDrawComponent())),m.createVideoPlaybackSystem(),y,A,B];d=[p,d,m.createQuadTreeSystem(b.getRenderer().getQuadTreeUpdater())];m=[C,m.createShaperSystem(v),m.createShaperSystem(x),z,h,b.getRenderer().getInvalidator()?m.createRenderingInvalidatorSystem(g,b.getRenderer().getInvalidator()):null].filter((a)=>null!=a);a=q.createChildScene(c,a.getBaseScene(),{initList:t,
inflateList:w,updateList:k,updateOnceList:d,preRenderList:m},!1);b.registerScene(g,a);b.setScene(a,a);return a}static createThumbnailScene(a,b,c,d){const g=a.getSceneBuilder();var h=g.getSystemFactory(),l=this.getThumbnailVisibilityKey();const m=h.createShaperSystem(new I.TriggeringVisibilityAggregatorSystemImpl([u.PlaybackModuleImpl.getPlaybackVisibilityKey()],[l],(a,b,c)=>e.Cet.updateVisibility(a).setAlpha(b).setEnabled(c))),p=b.getRenderer().createChannel(c);var q=h.createWorldGeometrySystem(),
r=f.CetModelEditor.createHideDegenerateConnectorsFixerSystem(h);const v=new V.ThumbnailVisibilitySystem(d,l);d=[m];l=[q,r];q=[h.createShaperSystem(u.PlaybackModuleImpl.createStageQuerySystem(b,n.Bacon.never().toProperty(),n.Bacon.never().toProperty(),f.ApplicationMode.View,u.PlaybackModuleImpl.getStageQueryKey())),q,h.createThumbnailOnlyVideoSystem(),h.createQuadTreeSystem(b.getRenderer().getQuadTreeUpdater())];r=[r];h=[v,m,b.getRenderer().getInvalidator()?h.createRenderingInvalidatorSystem(p,b.getRenderer().getInvalidator()):
null].filter((a)=>null!=a);a=g.createChildScene(c,a.getBaseScene(),{initList:d,inflateList:l,updateList:q,updateOnceList:r,preRenderList:h},!1);b.registerScene(p,a);return a}static getStageQueryKey(){null==u.PlaybackModuleImpl.stageQueryKey&&(u.PlaybackModuleImpl.stageQueryKey=h.CetModel.createValueComponentKey("playbackStageQuery",!1,!1));return u.PlaybackModuleImpl.stageQueryKey}static getThumbnailVisibilityKey(){null==u.PlaybackModuleImpl.thumbnailVisibilityKey&&(u.PlaybackModuleImpl.thumbnailVisibilityKey=
h.CetModel.createValueComponentKey("thumbnailVisiblity",!1,!1,!0));return u.PlaybackModuleImpl.thumbnailVisibilityKey}static createTopicVisibilitySystem(a,b,c,d){d=F.SelectionModule.createTopicOverlayAnimator(c.getCamera(),d);return new N.TopicVisibilitySystem(b,a,c.getEntityIdInFocusStream(),c,d)}static createLogoSystem(a,b,c,d){return new m.LogoSystem(a,b,c,d.getRenderer().getAssetManager(),d)}static createStageQuerySystem(a,b,c,d,e){return new U.StageQuerySystem(a,b,c,d,e)}static createVisibilityAggregator(a,
b){return new I.TriggeringVisibilityAggregatorSystemImpl(a,[],b)}static topicClosedFromNavigation(a,b){return{isClosed:a,eventType:b===e.NavigationActionAnimationType.Focus?q.TopicCloseEventType.CAMERA_JUMP:q.TopicCloseEventType.CAMERA_MOVE}}static topicClosedCommand(a,b){return{isClosed:a,eventType:b}}static getPlaybackVisibilityKey(){null==u.PlaybackModuleImpl.playbackVisibilityKey&&(u.PlaybackModuleImpl.playbackVisibilityKey=h.CetModel.createValueComponentKey("playbackVisibility",!1,!1));return u.PlaybackModuleImpl.playbackVisibilityKey}static createVisibilityFilter(a,
b,c,d){const g=new G.PlaybackVisibilityQuery,k=new Set(f.CetModelEditor.createTopicQuery(a).getReachableEntities(b,e.VisualBackgroundReachLevel.ALL_VISUALS_AND_BACKGROUND));b=()=>!0;const l=c?g.createGeneralVisibilityFilter(a):b,m=null!=d?g.createPathVisibilityFilter(d,a):b;return(b)=>{b=b.getId();return k.has(b)&&l(b)&&m(b)&&!a.getEntityById(b).isDef(h.CetModel.ID.Z_ZOOM_AREA)?1:0}}};var q={getWatermarkAssetUrl:function(){return v.getResourceUrl("watermark.png")}};Object.defineProperty(q,"__esModule",
{value:!0});(function(a){a[a.START_NEW_FLY=0]="START_NEW_FLY";a[a.JUMP=1]="JUMP"})(q.FlyMode||(q.FlyMode={}));(function(a){a[a.ZOOM_IN=0]="ZOOM_IN";a[a.ZOOM_OUT=1]="ZOOM_OUT";a[a.HOME=2]="HOME"})(q.ZoomEvent||(q.ZoomEvent={}));(function(a){a[a.INITIALIZE=0]="INITIALIZE";a[a.CAMERA_MOVE=1]="CAMERA_MOVE";a[a.CAMERA_JUMP=2]="CAMERA_JUMP";a[a.MANUAL=3]="MANUAL";a[a.COMPUTED=4]="COMPUTED"})(q.TopicCloseEventType||(q.TopicCloseEventType={}));q.PlaybackModule=u.PlaybackModuleImpl;return q});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_playback",["require","prezi.engine.dom","prezi.geometry","prezi.text.model","prezi_app_utils","prezi_bacon","prezi_canvas_listener","prezi_cet","prezi_cet_model","prezi_cet_model_editor","prezi_cet_renderer","prezi_editor_store_mode","prezi_editor_store_object","prezi_externalserviceprovider","prezi_featureswitcher","prezi_logger","prezi_select","prezi_uaparser","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_playback.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi.engine.dom"),require("prezi.geometry"),require("prezi.text.model"),require("prezi_app_utils"),require("prezi_bacon"),require("prezi_canvas_listener"),require("prezi_cet"),require("prezi_cet_model"),require("prezi_cet_model_editor"),require("prezi_cet_renderer"),require("prezi_editor_store_mode"),require("prezi_editor_store_object"),require("prezi_externalserviceprovider"),require("prezi_featureswitcher"),require("prezi_logger"),require("prezi_select"),require("prezi_uaparser"),require("prezi_utils"));}else{this["prezi_playback"]=__factory(this["prezi.engine.dom"],this["prezi.geometry"],this["prezi.text.model"],this["prezi_app_utils"],this["prezi_bacon"],this["prezi_canvas_listener"],this["prezi_cet"],this["prezi_cet_model"],this["prezi_cet_model_editor"],this["prezi_cet_renderer"],this["prezi_editor_store_mode"],this["prezi_editor_store_object"],this["prezi_externalserviceprovider"],this["prezi_featureswitcher"],this["prezi_logger"],this["prezi_select"],this["prezi_uaparser"],this["prezi_utils"]);}}).call(this);