;(function(){var baseUrl;var __factory=function(){var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "13.0-25-g6015dbc";},getModuleName:function(){return "prezi_service_assetloader";},getModuleVersion:function(){return "release-2021w06-base-26-gaeb382e";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.engine.dom":dependencies[0],"prezi.text":dependencies[1],"prezi.text.model":dependencies[2],"prezi_bacon":dependencies[3],"prezi_externalserviceprovider":dependencies[4],"prezi_logger":dependencies[5]}};})());};})(arguments);var moduleImpl=(function(){return module(function(d){function r(a,b,c=null){for(;a.hasNext();)c=b(c,a.next(),0);return c}function p(a,b){r(a,(a,d,e)=>b(d,e))}var t=d.dependencies["prezi.text"],u=d.dependencies.prezi_externalserviceprovider,l=d.dependencies.prezi_logger,e=d.dependencies.prezi_bacon;d={};Object.defineProperty(d,"__esModule",{value:!0});d.u=class{constructor(){}J(){return"noop"}w(){return{}}fetch(){const a=this.J(),b=this.w();if(!b[a]){let c=e.Bacon.newBus();this.K(c);c.onEnd(()=>b[a]=null);b[a]=c}return b[a]}};var h=
{};Object.defineProperty(h,"__esModule",{value:!0});h.L=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b}K(a){this.assetLoaderProvider.loadBinaryAsset(this.uri,(b)=>{a.push(b);a.end()},(b)=>{a.error({message:"Error loading binary asset: "+this.uri,data:b});a.end()})}J(){return this.uri}w(){return h.L.m}};h.L.m={};var g={};Object.defineProperty(g,"__esModule",{value:!0});(function(a){a.aa="font_loading_failed";a.N="json_parse_error"})(g.v||(g.v={}));var m={};Object.defineProperty(m,
"__esModule",{value:!0});m.ba=class extends d.u{constructor(a,b,c,d){super(d);this.document=a;this.ea=b;this.assetLoaderProvider=c;this.logger=l.LoggerModule.getLoggerManager().createLogger("FontFetcher")}K(a){const b=[],c={};p(this.document.getDocumentStyle().getFontFamilies().iterator(),(a)=>{p(a.getFontFaces().iterator(),(d)=>{const q=this.getFontFaceId(a,d),e=q.getId();c[e]||(b.push(this.ga(q,this.assetLoaderProvider.getFontUrl(d.getFontSrc()),d.getFontSrc())),c[e]=!0)})});const d=e.Bacon.mergeAll(b);
a.plug(d);d.onEnd(()=>a.end())}getFontFaceId(a,b){a=a.getName();const c=b.getFontWeight();b=b.getFontStyle();return null!=a&&null!=c&&null!=b?t.Layout.getFontFaceId(a,c,b):null}ga(a,b,c){const d=e.Bacon.newBus();this.ea.fontFromUrl(a,b,c).then(()=>{d.push({fontFaceId:a})},(b)=>{var c=b.error;let e={type:u.AssetLoadErrorType.AssetProcessingError,errorMessage:c};c=c.match(/[^{]*([{][^}]*[}])(.*)/);if(null!=c)try{e=JSON.parse(c[1]),e.errorMessage+=c[2]}catch(x){}d.push({fontFaceId:a,error:e});this.logger.error({action:g.v.aa,
object:"font_fetcher",trigger:"machine",payload:{error:b}})});return d.take(1)}};var f={};Object.defineProperty(f,"__esModule",{value:!0});f.j=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b;this.logger=l.LoggerModule.getLoggerManager().createLogger("ImageFetcher")}K(a){this.assetLoaderProvider.loadImageAsset(this.uri,(b)=>{0===b.width||0===b.height?(a.error({message:"image_with_0_size_was_downloaded"}),this.logger.error({action:"image_with_0_size_was_downloaded",
object:"image_fetcher",trigger:"machine",payload:{image_uri:this.uri}})):a.push(b);a.end()},()=>{a.error({message:"image_download_error"});this.logger.error({action:"image_download_error",object:"image_fetcher",trigger:"machine",payload:{image_uri:this.uri}});a.end()})}J(){return this.uri}w(){return f.j.m}};f.j.m={};var k={};Object.defineProperty(k,"__esModule",{value:!0});k.M=class extends d.u{constructor(a,b,c){super(c);this.uri=a;this.assetLoaderProvider=b;this.logger=l.LoggerModule.getLoggerManager().createLogger("JSONFetcher")}K(a){this.assetLoaderProvider.loadRemoteResource(this.uri,
(b)=>{try{a.push(JSON.parse(b))}catch(c){b=g.v.N+this.uri+" "+c,this.logger.error({action:g.v.N,object:"json_fetcher",trigger:"machine",payload:{json_url:this.uri,error:c.toString()}}),a.error({message:b})}a.end()},()=>{const b=`Failed to load remote resource: ${this.uri}`;this.logger.error({action:"failed_to_load_resource",object:"json_fetcher",trigger:"machine",payload:{json_url:this.uri}});a.error({message:b});a.end()})}J(){return this.uri}w(){return k.M.m}};k.M.m={};var n={};Object.defineProperty(n,
"__esModule",{value:!0});class v{constructor(a,b,c,d){this.uri=a;this.id=b;this.assetLoaderProvider=c;this.f=d;this.O=e.Bacon.newBus()}getId(){return this.id}ha(){const a=(new f.j(this.uri,this.assetLoaderProvider,this.f)).fetch().take(1);this.O.plug(a);return a}}class w{constructor(a){this.ja=a;this.enabled=!0;this.o=[]}U(a){if(0===a.length)return e.Bacon.once(null);a=a.map((a)=>a.ha().mapEnd((a)=>a));return e.Bacon.combineWithA((...a)=>a,a).take(1)}da(){this.ia();const a=this.ja.getUrgentIds(),
b=this.o.filter((b)=>0<=a.indexOf(b.getId())),c=this.o.filter((b)=>0>a.indexOf(b.getId()));this.o=[];this.U(b).onValue(()=>this.U(c))}ca(a){this.o.push(a)}ia(){this.enabled=!1}isEnabled(){return this.enabled}fa(a){return this.o.filter((b)=>b.uri===a)}}n.W=class{constructor(a){this.assetLoaderProvider=a;this.f=e.Bacon.newBus()}setUrgentIdLister(a){this.i=new w(a)}downloadInitialBatch(){null!=this.i&&this.i.da()}createBinaryFetcher(a){return new h.L(a,this.assetLoaderProvider,this.f)}createJSONFetcher(a){return new k.M(a,
this.assetLoaderProvider,this.f)}createImageFetcher(a){return new f.j(a,this.assetLoaderProvider,this.f)}addImageDownloadTask(a,b){if(null!=this.i&&this.i.isEnabled()){const c=this.i.fa(a);0===c.length?(a=new v(a,b,this.assetLoaderProvider,this.f),this.i.ca(a)):a=c[0];return a.O}return(new f.j(a,this.assetLoaderProvider,this.f)).fetch()}createFontSetFetcher(a,b){return new m.ba(a,b,this.assetLoaderProvider,this.f)}getUrlRewriter(){return this.assetLoaderProvider}getAssetFetchingErrorObservable(){return this.f}};
d={};Object.defineProperty(d,"__esModule",{value:!0});(function(a){a.createAssetManager=function(a){return new n.W(a)}})(d.AssetLoader||(d.AssetLoader={}));return d});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_service_assetloader",["require","prezi.engine.dom","prezi.text","prezi.text.model","prezi_bacon","prezi_externalserviceprovider","prezi_logger"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_service_assetloader.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("prezi.engine.dom"),require("prezi.text"),require("prezi.text.model"),require("prezi_bacon"),require("prezi_externalserviceprovider"),require("prezi_logger"));}else{this["prezi_service_assetloader"]=__factory(this["prezi.engine.dom"],this["prezi.text"],this["prezi.text.model"],this["prezi_bacon"],this["prezi_externalserviceprovider"],this["prezi_logger"]);}}).call(this);