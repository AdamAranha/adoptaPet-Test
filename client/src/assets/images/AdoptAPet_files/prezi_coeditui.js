;(function(){var baseUrl;var __factory=function(){var React=arguments[0];var ReactDOM=arguments[1];var ReactTransitionGroup=arguments[2];var module=(function(dependencies){return function(init){return init.call({},(function(){return{getSpaghettiVersion:function(){return "13.0-25-g6015dbc";},getModuleName:function(){return "prezi_coeditui";},getModuleVersion:function(){return "release-2021w06-base-26-gaeb382e";},getResourceUrl:function(resource){if(resource.substr(0,1)!="/"){resource="/"+resource;}return baseUrl+resource;},"dependencies":{"prezi.geometry":dependencies[3],"prezi_bacon":dependencies[4],"prezi_cet":dependencies[5],"prezi_cet_model":dependencies[6],"prezi_cet_renderer":dependencies[7],"prezi_editor_store_object":dependencies[8],"prezi_i18n":dependencies[9],"prezi_koi_widgets":dependencies[10],"prezi_logger":dependencies[11],"prezi_utils":dependencies[12]}};})(),React,ReactDOM,ReactTransitionGroup);};})(arguments);var moduleImpl=(function(){return module(function(g,f,r,x){var u=g.dependencies.prezi_i18n,t=g.dependencies.prezi_bacon,m=g.dependencies.prezi_cet,n=g.dependencies.prezi_logger,v=g.dependencies.prezi_utils,p=g.dependencies["prezi.geometry"],w=g.dependencies.prezi_cet_renderer,k=g.dependencies.prezi_koi_widgets,h={};Object.defineProperty(h,"__esModule",{value:!0});h.CoeditUIAvatar=class{constructor(a,b,c){this.domLayer=a;this.user=b;this.editScene=c;this.clientUuid=b.clientUuid;this.hidden=!1;this.logger=n.LoggerModule.getLoggerManager().createLogger("prezi_coeditui.CoeditUIAvatar")}getDomElementId(){return this.domElementId}setHidden(a){this.hidden=
a}isHidden(){return this.hidden}getClientUuid(){return this.clientUuid}dispose(){null!=this.domElement&&(null!=this.container&&this.container.parentElement&&this.domElement.parentElement===this.container&&this.container.removeChild(this.domElement),this.domElementId=this.domElement=null);this.container&&0===this.container.children.length&&this.container.parentElement&&(this.container.parentElement.removeChild(this.container),this.container=null)}refresh(a,b){b&&!this.domElementId&&(this.domElement=
this.createAvatarDomElement(this.user,b),this.domElementId=this.domElement.id);if(this.domElement&&b){var c=$(this.domElement);this.isVisible(a,b)?(c.css({display:"block"}),a=this.getEntityTopLeftCorner(b),null!=a?(c=p.Geometry.createTranslation(a.x,a.y),this.domLayer.positionElementToCenter(this.domElementId,h.CoeditUIAvatar.ICON_SIZE,h.CoeditUIAvatar.ICON_SIZE),this.domLayer.transformWithoutScaleAndRotation(this.domElementId,c),this.offsetAvatar()):c.css({display:"none"})):c.css({display:"none"})}else this.logger.debug({action:"render",
object:"floating-avatar",trigger:"machine",feature:"coedit-ui",payload:{message:"This shouldn't be rendered anymore!"}})}createAvatarDomElement(a,b){var c=b.getId();const d=b.getDef().getName();b=this.domLayer.createElement(`${h.CoeditUIAvatar.COEDITUI_AVATAR_ID_PREFIX}_${this.clientUuid}_${c}`);b.className="coedit-ui-avatar";b.style.display="block";c=this.getContainer(c);this.domLayer.insertUIElement(c,b);a={firstName:a.firstName,lastName:a.lastName,userName:a.userName,onClick:()=>{this.logger.info({action:"click",
object:"avatar",trigger:"user",feature:"coedit",payload:{message:"Floating avatar clicked",location_tag:"entity",object_type:d}})}};a=k.KoiWidgetsModule.getWidgetFactory().avatar(a);r.render(a,b,()=>{});return b}isVisible(a,b){return this.isSceneAncestorOf(this.editScene,a.getRenderedScene())&&!this.hidden&&null!=m.Cet.visibility(b)&&m.Cet.visibility(b).isVisible()?!0:!1}getEntityTopLeftCorner(a){if(null==a)return null;a=a.getComponent(w.CetRendererModule.getWorldGeometryComponentKey());if(null==
a)return null;var b=a.getWorldBounds();a=h.CoeditUIAvatar.AVATAR_BASE_MARGIN/this.domLayer.getCameraScale();a=Math.min(a,b.getWidthHalf());const c=p.Geometry.fromPoint(b.getVertices()[0]);b=p.Geometry.fromPoint(b.getVertices()[1]).sub(c);b.setLength(a);return c.add(b).toPoint()}getContainer(a){this.container||(this.container=this.domLayer.createElement(`coedit-ui-avatar-container_${a}`),this.container.style.display="block");return this.container}offsetAvatar(){if(null!=this.domElement.parentElement){var a=
[].slice.call(this.domElement.parentElement.children).indexOf(this.domElement);a=Math.round((this.domElement.parentElement.children.length-a-1)*h.CoeditUIAvatar.ICON_SIZE*h.CoeditUIAvatar.ICON_OFFSETTING_RATIO);const b=$(this.domElement);b.css("left",parseInt(b.css("left"),10)+a)}}isSceneAncestorOf(a,b){for(;null!=b;){if(b===a)return!0;b=b.getParentScene()}return!1}};h.CoeditUIAvatar.COEDITUI_AVATAR_ID_PREFIX="c_overlay_avatar_";h.CoeditUIAvatar.AVATAR_BASE_MARGIN=30;h.CoeditUIAvatar.ICON_SIZE=36;
h.CoeditUIAvatar.ICON_OFFSETTING_RATIO=.33;var e={};Object.defineProperty(e,"__esModule",{value:!0});e.CoeditUIMenu=class extends f.Component{constructor(a){super(a);this.logger=n.LoggerModule.getLoggerManager().createLogger("prezi_coeditui.CoeditUIMenu");this.coeditUIController=a.coeditUIController;this.state={activeCoeditors:[],collaborators:[],collaboratorsPresent:[]};this.activeUsersStreamOnValueTimer=this.coeditUIController.getActiveUsersStream().onValue((a)=>{this.setState({activeCoeditors:a})});
this.collaboratorListStreamOnValueTimer=this.coeditUIController.getCollaboratorListStream().onValue((a)=>{this.setState({collaborators:a})});this.collaboratorsPresentStreamOnValueTimer=this.coeditUIController.getCollaboratorsPresentStream().onValue((a)=>{this.setState({collaboratorsPresent:a})})}componentWillUnmount(){"function"===typeof this.activeUsersStreamOnValueTimer&&this.activeUsersStreamOnValueTimer();"function"===typeof this.collaboratorListStreamOnValueTimer&&this.collaboratorListStreamOnValueTimer();
"function"===typeof this.collaboratorsPresentStreamOnValueTimer&&this.collaboratorsPresentStreamOnValueTimer()}componentWillMount(){this.coeditUIController.initializeData()}render(){this.styles={popup:{width:240},content:{padding:12},noCoeditorsLabel:{height:220,textAlign:"center",display:"table-cell",verticalAlign:"middle",whiteSpace:"normal",wordWrap:"normal",letterSpacing:".5px",fontFamily:"RalewaySemiBold",fontSize:16},collaboratorsButton:{backgroundColor:"#dbdfe5",border:"none!",marginTop:6,
padding:4,width:"95%",color:"#152235",margin:"auto",display:"block",textAlign:"center"},collaboratorsSection:{border:"none!",marginTop:6,padding:4,display:"flex",flexDirection:"row",textAlign:"center"},inThePreziLabel:{textAlign:"start",fontVariant:"small-caps",letterSpacing:".5px",padding:"5px",fontFamily:"RalewaySemiBold",fontSize:16},avatarList:{maxHeight:240,width:240,overflow:"auto"},avatarItem:{display:"inline-block",margin:2,cursor:"default"},avatarBlock:{display:"flex",alignItems:"center"},
numberIndicator:{display:"inline-block",margin:2,cursor:"default",backgroundColor:"#929AA3"}};const {isOffline:a,isOnboarding:b}=this.props;if(a||b)return null;var {collaboratorsPresent:c}=this.state;const d=c.find((a)=>a.isSelf());c=c.filter((a)=>!a.isSelf());return f.createElement("div",{id:e.CoeditUIMenu.COEDIT_UI_MENU_ID,key:e.CoeditUIMenu.COEDIT_UI_MENU_ID,className:e.CoeditUIMenu.COEDIT_UI_MENU_ID,style:this.styles.collaboratorsSection},d&&f.createElement("div",{id:e.CoeditUIMenu.COEDITORS_ME_ID},
this.createAvatarIcon(d.getFirstName(),d.getLastName(),d.getUserName())),0<c.length&&this.createUserNumberIndicator(c))}componentDidMount(){this.setState({anchorNode:r.findDOMNode(this.refs&&this.refs[e.CoeditUIMenu.COEDITORS_BUTTON_ID])})}getDropdownContent(a){let b=f.createElement(k.KoiWidgets.Label,{text:u.I18n.ts("collaborating now").toLocaleLowerCase(),style:this.styles.inThePreziLabel});a=a.map((a,b)=>({children:[this.createAvatar(a.getFirstName(),a.getLastName(),a.getUserName())],onRemove:null,
key:e.CoeditUIMenu.COEDIT_UI_MENU_ROW_CLASS+b,style:{border:"0"}}));return f.createElement("div",null,b,f.createElement(k.KoiWidgets.Divider,null),f.createElement(k.KoiWidgets.List,{key:e.CoeditUIMenu.COEDITORS_LIST_ID,style:this.styles.avatarList,isLoading:!1,items:a,gradientFader:!0}))}createUserNumberIndicator(a){return f.createElement("div",{id:e.CoeditUIMenu.COEDITORS_BUTTON_ID,onClick:()=>{this.props.isDropdownOpen?this.coeditUIController.closeMenu():(this.logger.info({action:"open",object:"show_collaborators",
trigger:"button",feature:"coedit",payload:{message:"Show collaborators menu opened"}}),this.coeditUIController.openMenu())}},f.createElement(k.KoiWidgets.Avatar,{style:this.styles.numberIndicator,firstName:"+",lastName:a.length.toString(),userName:""}),f.createElement("div",null,f.createElement(k.KoiWidgets.SimplePopup,{className:e.CoeditUIMenu.POPUP_ID,styles:{popup:this.styles.popup},open:this.props.isDropdownOpen,orientation:"BOTTOM"},this.getDropdownContent(a))))}createAvatarIcon(a,b,c){return f.createElement(k.KoiWidgets.Avatar,
{style:this.styles.avatarItem,firstName:a,lastName:b,userName:c,onClick:()=>{this.logger.info({action:"click",object:"avatar",trigger:"user",feature:"coedit",payload:{message:"Collaborator list avatar clicked",location_tag:"collaborator_list",object_type:"collaborator_name"}})}})}createAvatar(a,b,c){return f.createElement("div",{className:e.CoeditUIMenu.COEDIT_UI_MENU_ROW_CLASS},f.createElement("div",{style:this.styles.avatarBlock},this.createAvatarIcon(a,b,c),f.createElement(k.KoiWidgets.Label,{text:`${a} ${b}`})))}};
e.CoeditUIMenu.POPUP_ID="coedit-ui-dropdown-menu";e.CoeditUIMenu.COEDITORS_BUTTON_ID="coedit-ui-menu-button";e.CoeditUIMenu.COEDITORS_ME_ID="coedit-ui-menu-me";e.CoeditUIMenu.COEDITORS_LIST_ID="coedit-ui-list";e.CoeditUIMenu.COEDIT_UI_MENU_ID="coedit-ui-menu";e.CoeditUIMenu.COLLABORATORS_BUTTON_ID="coedit-ui-collaborators-button";e.CoeditUIMenu.COEDIT_UI_MENU_ROW_CLASS="coedit-ui-list-row";e.CoeditUIMenu.COLLABORATOR_NAME_KEY="coedit-ui-collaborator-name";e.CoeditUIMenu.COLLABORATOR_AVATAR_KEY="coedit-ui-collaborator-avatar";
var l={};Object.defineProperty(l,"__esModule",{value:!0});l.CoeditUIControllerImpl=class{constructor(a,b,c){this.logger=n.LoggerModule.getLoggerManager().createLogger("prezi_coeditui.CoeditUIControllerImpl");this.peerSelectionStream=b;this.activeUsersStream=this.transformUserStream(a);this.collaboratorsPresentStream=this.filterCollaboratorsPresent(a);this.openPopupIdStream=t.Bacon.newBus();this.openPopupIdStream.onValue((a)=>c(a));this.collaboratorStream=t.Bacon.newBus();this.isDropdownOpen=!1;this.lastActiveUsers=
[];this.lastActivePeerSelection={};this.activeUsersFloatingAvatars={};this.activeUsersStream.onValue(()=>{})}static getCoeditUIComponentKeyForClientUuid(a){return m.Cet.createOverlayComponentKey("coeditUIOverlay-"+a)}getCollaboratorsPresentStream(){return this.collaboratorsPresentStream}getActiveUsersStream(){return this.activeUsersStream}setShareService(a){this.collaboratorInfoService=a}getCollaboratorListStream(){return this.collaboratorStream}getOpenPopupIdStream(){return this.openPopupIdStream}openMenu(){this.requestCollaboratorUpdate();
this.openPopupIdStream.push(e.CoeditUIMenu.POPUP_ID)}closeMenu(){return this.openPopupIdStream.push(null)}initializeData(){this.requestCollaboratorUpdate()}initHoverAvatarRendering(a,b,c,d){this.domLayer=c;this.mainStage=d;this.baseScene=b;this.editScene=a;this.peerSelectionStream.onValue((a)=>{v.Utils.arrayEquals(this.lastActivePeerSelection[a.clientUuid],a.selectedEntityIds)||(this.lastActivePeerSelection[a.clientUuid]=a.selectedEntityIds,this.alignAvatarsToPeerSelection(a.clientUuid,a.selectedEntityIds))});
this.activeUsersStream.onValue((a)=>{this.lastActiveUsers=a;this.clearInactiveUserAvatars();this.lastActiveUsers.forEach((a)=>{var b=a.getClientUuid();b=this.lastActivePeerSelection[b];this.alignAvatarsToPeerSelection(a.getClientUuid(),b)})})}alignAvatarsToPeerSelection(a,b){let c=this.lastActiveUsers.filter((b)=>b.getClientUuid()===a)[0];if(c){var d=this.extractFlatUserObj(c);this.baseScene.requestNoDomBatchUpdate((a)=>{this.updateAvatarsForNewSelection(this.activeUsersFloatingAvatars,d,b,a)})}}updateAvatarsForNewSelection(a,
b,c,d){c&&0!==c.length?c.map((a)=>d.getEntityById(a)).every((a)=>!a)||this.disposeAllAvatarsForUser(b.clientUuid,a,d,()=>{c.forEach((c)=>{this.attachAvatar(b,c,d,a)})}):this.disposeAllAvatarsForUser(b.clientUuid,a,d)}attachAvatar(a,b,c,d){if(a=this.createFloatingAvatar(a,b,c))c=a.getClientUuid(),d[c]||(d[c]={}),d[c][b]=a}disposeAllAvatarsForUser(a,b,c,d){let e=b[a];if(e&&Object.keys(e).length){let f=Object.keys(e);c.requestNoDomBatchUpdate((b)=>{f.forEach((c)=>{let d=b.getEntityById(c);if(d){let b=
l.CoeditUIControllerImpl.getCoeditUIComponentKeyForClientUuid(a),f=d.getComponent(b);f?f.dispose():null!=e[c]?e[c].dispose():this.logger.warn({action:"disposeError",object:"coeditUIController",trigger:"collaboratorChange",feature:"coedit-ui",payload:{message:"Coedit UI component can't be disposed.",clientUuid:a,entityId:c,componentKey:b.getName()}});d.discardOwnComponent(l.CoeditUIControllerImpl.getCoeditUIComponentKeyForClientUuid(a))}});d&&d()});b[a]={}}else d&&d()}createFloatingAvatar(a,b,c){b=
c.getEntityById(b);if(!b)return null;c=new h.CoeditUIAvatar(this.domLayer,a,this.editScene);let d=m.Cet.createOverlayComponent(c,c);c.refresh(this.mainStage,b);b.setComponent(l.CoeditUIControllerImpl.getCoeditUIComponentKeyForClientUuid(a.clientUuid),d);return c}transformUserStream(a){return a.map(this.filterActiveUsersInArray)}filterCollaboratorsPresent(a){return a.map(this.presentCollaboratorsInArray)}filterActiveUsersInArray(a){return a.filter((a)=>!a.isDisconnected()).filter((a)=>!a.isSelf()).filter((a,
c,d)=>d.map((a)=>a.getClientUuid()).indexOf(a.getClientUuid())===c)}presentCollaboratorsInArray(a){return a.filter((a)=>!a.isDisconnected()).filter((a,c,d)=>d.map((a)=>a.getClientUuid()).indexOf(a.getClientUuid())===c)}extractFlatUserObj(a){return{userName:a.getUserName(),firstName:a.getFirstName(),lastName:a.getLastName(),clientUuid:a.getClientUuid()}}clearInactiveUserAvatars(){let a=this.lastActiveUsers.map((a)=>a.getClientUuid());Object.keys(this.activeUsersFloatingAvatars).filter((b)=>-1===a.indexOf(b)).forEach((a)=>
{this.disposeAllAvatarsForUser(a,this.activeUsersFloatingAvatars,this.baseScene)})}requestCollaboratorUpdate(){this.collaboratorInfoService&&this.collaboratorInfoService.getCollaborators((a)=>{this.collaboratorStream.push(a)},(a)=>{this.logger.warn({action:"requestCollaboratorUpdate",object:"coeditUIController",trigger:"click",feature:"coedit",payload:{message:"Collaborator Info Service returned error",errorObj:a}})})}};var q={};Object.defineProperty(q,"__esModule",{value:!0});q.CoeditUISectionImpl=
class{constructor(a){this.coeditUIController=a;this.coeditUIMenuFactory=f.createFactory(e.CoeditUIMenu)}createCoeditUIPanel(a,b,c,d){return this.coeditUIMenuFactory({coeditUIController:this.coeditUIController,isDropdownOpen:c===e.CoeditUIMenu.POPUP_ID,openShareDialogCallback:d,isOffline:a,isOnboarding:b})}};g={};Object.defineProperty(g,"__esModule",{value:!0});(function(a){a.createCoeditUIController=function(a,c,d){return new l.CoeditUIControllerImpl(a,c,d)};a.createCoeditUISection=function(a){return new q.CoeditUISectionImpl(a)}})(g.CoeditUIModule||
(g.CoeditUIModule={}));return g});

})() || {};
moduleImpl["module"]=moduleImpl;
return moduleImpl;};if(typeof define==="function"&&define.amd){define("prezi_coeditui",["require","react","react-dom","react-transition-group","prezi.geometry","prezi_bacon","prezi_cet","prezi_cet_model","prezi_cet_renderer","prezi_editor_store_object","prezi_i18n","prezi_koi_widgets","prezi_logger","prezi_utils"],function(){var moduleUrl=arguments[0]["toUrl"]("prezi_coeditui.js");baseUrl=moduleUrl.substr(0,moduleUrl.lastIndexOf("/"));return(__factory).apply({},[].slice.call(arguments,1));});}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){baseUrl=__dirname;module.exports=(__factory)(require("react"),require("react-dom"),require("react-transition-group"),require("prezi.geometry"),require("prezi_bacon"),require("prezi_cet"),require("prezi_cet_model"),require("prezi_cet_renderer"),require("prezi_editor_store_object"),require("prezi_i18n"),require("prezi_koi_widgets"),require("prezi_logger"),require("prezi_utils"));}else{this["prezi_coeditui"]=__factory(React,ReactDOM,ReactTransitionGroup,this["prezi.geometry"],this["prezi_bacon"],this["prezi_cet"],this["prezi_cet_model"],this["prezi_cet_renderer"],this["prezi_editor_store_object"],this["prezi_i18n"],this["prezi_koi_widgets"],this["prezi_logger"],this["prezi_utils"]);}}).call(this);